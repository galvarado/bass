{% extends "base.html" %}
{% load humanize %}

{% block title %}Evidencias · Viaje #{{ trip.id }} · BASS{% endblock %}
{% block content %}

<style>
  .pill { padding: .18rem .55rem; border-radius: 999px; font-size: .75rem; font-weight: 600; }
  .pill-ok { background: rgba(28,200,138,.15); color: #1cc88a; }
  .pill-warn { background: rgba(246,194,62,.15); color: #b58900; }
  .pill-gray { background: rgba(133,135,150,.14); color: #6c757d; }
  .mini-muted { font-size: .78rem; color: #858796; }
  .thumb { width: 90px; height: 68px; object-fit: cover; border-radius: .35rem; border: 1px solid #e3e6f0; }
  .card .card-header { background: #fff; }
  .help { font-size: .78rem; color: #858796; margin-top: .25rem; }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 mb-0">Evidencias</h1>
    <div class="small text-muted">
      Viaje <strong>#{{ trip.id }}</strong> · {{ trip.route }}
    </div>

    <div class="mini-muted mt-1">
      Status:
      {% if trip.status == "PROGRAMADO" %}
        <span class="pill pill-warn">Programado</span>
      {% else %}
        <span class="pill pill-gray">{{ trip.get_status_display }}</span>
      {% endif %}
    </div>
  </div>

  <div>
    <a class="btn btn-sm btn-outline-secondary" href="{% url 'trips:my_detail' trip.id %}">
      <i class="fas fa-arrow-left"></i> Volver
    </a>
  </div>
</div>

{# ===== Requeridas para liquidación ===== #}
<div class="card mb-3">
  <div class="card-body py-3">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
      <div>
        <div class="font-weight-bold">Requeridas para liquidación</div>
        <div class="mini-muted">Foto de la carga + foto del sello</div>
      </div>

    </div>
  </div>
</div>

{# ===== Subir evidencias (2 archivos) ===== #}
<div class="card mb-3">
  <div class="card-header py-3">
    <h6 class="m-0 font-weight-bold text-primary">
      <i class="fas fa-camera mr-1"></i> Subir evidencias (Carga y Sello)
    </h6>
  </div>

  <div class="card-body">

    {% if not can_upload %}
      <div class="alert alert-warning mb-0">
        No puedes subir evidencias mientras el viaje esté en <strong>PROGRAMADO</strong>.
      </div>
    {% else %}
      <form method="post" enctype="multipart/form-data" class="form-compact">
        {% csrf_token %}

        {# Errores generales que tú mandes desde la view (messages o form_errors) #}
        {% if form_errors %}
          <div class="alert alert-danger">
            {{ form_errors }}
          </div>
        {% endif %}

        <div class="form-row">
          <div class="col-md-5 mb-3">
            <label class="small text-muted mb-1">Foto de la carga</label>
            <input type="file"
                   name="load_image"
                   accept="image/*"
                   class="form-control-file">
            <div class="help">Sube una foto clara de la carga.</div>
          </div>

          <div class="col-md-5 mb-3">
            <label class="small text-muted mb-1">Foto del sello</label>
            <input type="file"
                   name="seal_image"
                   accept="image/*"
                   class="form-control-file">
            <div class="help">Sube una foto clara del sello.</div>
          </div>

          <div class="col-md-2 mb-3">
            <label class="small text-muted mb-1">Notas</label>
            <input type="text"
                   name="notes"
                   maxlength="280"
                   class="form-control form-control-sm"
                   placeholder="Opcional">
          </div>
        </div>

        <div class="text-right">
          <button class="btn btn-sm btn-primary" type="submit">
            <i class="fas fa-upload"></i> Subir evidencias
          </button>
        </div>

      </form>
    {% endif %}
  </div>
</div>

{# ===== Tabla de evidencias ===== #}
<div class="card">
  <div class="card-header py-3 d-flex justify-content-between align-items-center">
    <h6 class="m-0 font-weight-bold text-primary">
      <i class="fas fa-images mr-1"></i> Evidencias del viaje
    </h6>
    <div class="small text-muted">{{ evidences|length }} archivo{{ evidences|length|pluralize:"s" }}</div>
  </div>

  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="thead-light">
          <tr>
            <th style="width: 120px;">Preview</th>
            <th>Tipo</th>
            <th>Notas</th>
            <th>Subida</th>
          </tr>
        </thead>
        <tbody>
          {% for e in evidences %}
            <tr>
              <td>
                {% if e.image %}
                  <a href="{{ e.image.url }}" target="_blank" title="Abrir">
                    <img src="{{ e.image.url }}" class="thumb" alt="evidencia">
                  </a>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>

              <td>
                {% if e.evidence_type == "load" %}
                  <span class="pill pill-ok">Carga</span>
                {% elif e.evidence_type == "seal" %}
                  <span class="pill pill-ok">Sello</span>
                {% else %}
                  <span class="pill pill-gray">{{ e.get_evidence_type_display }}</span>
                {% endif %}
              </td>

              <td>
                {% if e.notes %}
                  {{ e.notes }}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>

              <td>
                <div class="small">{{ e.uploaded_at|date:"d/m/Y H:i" }}</div>
                <div class="mini-muted">{% if e.uploaded_by %}{{ e.uploaded_by }}{% else %}—{% endif %}</div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="4" class="text-center text-muted py-4">
                Aún no hay evidencias cargadas.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}
