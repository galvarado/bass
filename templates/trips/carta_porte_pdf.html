{% load static %}
{% load humanize %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <style>
    /* ===== Page & Typography ===== */
    @page { size: Letter; margin: 10mm; }
    body { font-family: Arial, Helvetica, sans-serif; font-size: 9pt; color: #0a0a0a; }
    * { box-sizing: border-box; }

    /* ===== Colors (match sample’s deep blue) ===== */
    :root{
      --blue:#0d2b7d;
      --blue2:#123a9a;
      --line:#1f3f9b;
      --light:#f5f7ff;
      --text:#0a0a0a;
      --muted:#4c4c4c;
      --border:#1f3f9b;
    }

    /* ===== Utilities ===== */
    .mb6{ margin-bottom: 6px; }
    .mb10{ margin-bottom: 10px; }
    .mb12{ margin-bottom: 12px; }
    .mt8{ margin-top: 8px; }
    .mt10{ margin-top: 10px; }
    .small{ font-size: 7pt; }
    .tiny{ font-size: 6pt; }
    .muted{ color: var(--muted); }
    .right{ text-align: right; }
    .center{ text-align: center; }
    .nowrap{ white-space: nowrap; }

    /* ===== Header layout (ALL pages) ===== */
    .header-wrap{
      display: grid;
      grid-template-columns: 36% 64%;
      gap: 8px;
      align-items: stretch;
      margin-bottom: 10px;
    }

    .brand-card{
      border: 2px solid var(--border);
      padding: 6px;
      min-height: 110px;
    }

    /* Respeta tu cabecera: logo SOLO en una fila, textos abajo */
    .brand-row { display: block !important; }
    .brand-logo-row{
      text-align: center;
    }
    .brand-logo{
      width: 200px;
      height: auto;
      display: inline-block;
    }
    .brand-title-row{ margin-bottom: 2px; }
    .brand-name{
      font-weight: 700;
      color: var(--blue);
      font-size: 9pt;
      line-height: 1.1;
      text-align: center;
    }
    .brand-sub{
      font-weight: 300;
      color: var(--blue);
      font-size: 5pt;
      margin-top: 2px;
      line-height: 1.15;
      text-align: center;
    }
    .brand-meta{
      margin-top: 6px;
      font-size: 6pt;
      line-height: 1.2;
      text-align: center;
    }

    .cert-table{
      width: 100%;
      border-collapse: collapse;
      border: 2px solid var(--border);
      table-layout: fixed;
      min-height: 110px;
    }
    .cert-table th{
      background: var(--blue);
      color: #fff;
      padding: 5px 6px;
      font-size: 8pt;
      text-transform: none;
      border: 1px solid var(--border);
    }
    .cert-table td{
      border: 1px solid var(--border);
      padding: 5px 6px;
      font-size: 8pt;
      vertical-align: middle;
    }
    .cert-table .hl{
      color: #c40000;
      font-weight: 700;
    }

    /* ===== Section bars ===== */
    .bar{
      background: var(--blue);
      color: #fff;
      font-weight: 700;
      padding: 5px 8px;
      border: 2px solid var(--border);
      border-bottom: 0;
      font-size: 9pt;
      letter-spacing: .2px;
    }
    .box{
      border: 2px solid var(--border);
      padding: 8px;
    }

    /* ===== Two columns info blocks ===== */
    .grid-2{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    /* ===== Tables ===== */
    table.tbl{
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    .tbl th{
      background: var(--blue);
      color: #fff;
      border: 1px solid var(--border);
      padding: 5px 6px;
      font-size: 9pt;
    }
    .tbl td{
      border: 1px solid var(--border);
      padding: 5px 6px;
      font-size: 9pt;
      vertical-align: top;
    }

    /* ===== Totals + amount in words ===== */
    .cost-grid{
      display: grid;
      grid-template-columns: 1fr 220px;
      gap: 8px;
      align-items: start;
    }
    .amount-words{
      border: 2px solid var(--border);
      padding: 6px 8px;
      font-size: 9pt;
      line-height: 1.2;
    }
    .amount-words .label{
      font-weight: 700;
      color: var(--blue);
      margin-bottom: 3px;
      font-size: 9pt;
    }

    table.totals{
      width: 100%;
      border-collapse: collapse;
      border: 2px solid var(--border);
      font-size: 9pt;
    }
    .totals th{
      background: var(--blue);
      color:#fff;
      border: 1px solid var(--border);
      padding: 6px 8px;
      text-align:left;
      width: 55%;
    }
    .totals td{
      border: 1px solid var(--border);
      padding: 6px 8px;
      text-align: right;
      width: 45%;
    }
    .totals tr.grand th,
    .totals tr.grand td{
      font-weight:700;
    }

    /* ===== Leyendas ===== */
    .legend{
      margin-top: 6px;
      text-align: center;
      font-size: 5pt;
      font-weight: 700;
      color: var(--blue);
      line-height: 1.25;
    }
    .legend .warn{
      color: #c40000;
      display: inline-block;
      margin: 3px 0;
      padding: 2px 6px;
      border: 1px solid #c40000;
    }

    /* ===== Pagaré ===== */
    .pagare{
      margin-top: 10px;
      font-size: 7pt;
      line-height: 1.25;
      page-break-inside: avoid;
    }

    /* ===== Footer QR + seals ===== */
    .footer-wrap{
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 10px;
      align-items: start;
      margin-top: 10px;
    }
    .qr{
      border: 2px solid var(--border);
      padding: 6px;
      text-align: center;
    }
    .qr img{ width: 120px; height: 120px; }

    .seal-block{
      border: 2px solid var(--border);
      padding: 8px;
    }
    .seal-title{
      font-weight: 700;
      color: var(--blue);
      margin-bottom: 4px;
      font-size: 7pt;
    }
    .mono{
      font-family: "Courier New", Courier, monospace;
      font-size: 6pt;
      word-break: break-all;
      line-height: 1.15;
    }

    .page-foot{
      margin-top: 20px;
      text-align: center;
      font-size: 8pt;
      color: var(--blue);
      font-weight: 700;
    }

    .page-break{ page-break-after: always; }
  </style>
</head>

<body>

{% with raw=carta.response_snapshot.raw %}
{% with issuer=raw.issuer_info %}
{% with issuer_addr=issuer.address %}
{% with addr=raw.address %}
{% with cust=raw.customer %}
{% with item=raw.items|first %}
{% with prod=item.product %}
{% with taxes=prod.taxes %}
{% with stamp=raw.stamp %}

  <!-- =========================================================
       PAGE 1 (como tu ejemplo)
  ========================================================== -->

  <!-- ===== Header (igual a otras páginas) ===== -->
  <div class="header-wrap">

    <div class="brand-card">
      <div class="brand-logo-row">
        <img class="brand-logo" src="{% static 'img/basslogo.png' %}" alt="BASS" />
      </div>

      <div class="brand-title-row">
        <div class="brand-name">AUTO TRANSPORTES BASS</div>
        <div class="brand-sub">SERVICIO PUBLICO FEDERAL ESPECIALIZADO EN REFRIGERACION</div>
      </div>

      <div class="brand-meta">
        {# Dirección desde JSON #}
        {% if addr %}
          {{ addr.street|default:"" }} {{ addr.exterior|default:"" }}{% if addr.interior %} INT {{ addr.interior }}{% endif %},
          {{ addr.neighborhood|default:"" }}<br/>
          {{ addr.city|default:"" }}, {{ addr.state|default:"" }} CP {{ addr.zip|default:"" }}
        {% else %}
          CHILPANCINGO 962 INT 1 COL. JARDINES DEL CARMEN<br/>LA PIEDAD, MICHOACAN CP 59389
        {% endif %}
        <br/>
        <span>TEL:</span> {{ carta.response_snapshot.emisor_tel|default:"352 688 0736" }}<br/>
        <span>Correo electrónico:</span> {{ carta.response_snapshot.emisor_email|default:"atencion.clientes@autotransportesbass.com" }}
      </div>
    </div>

    <table class="cert-table">
      <tr>
        <th>Certificado del Emisor</th>
        <th>Folio Fiscal Complemento(UUID)</th>
      </tr>
      <tr>
        <td class="center">—</td>
        <td class="center">{{ raw.uuid|default:carta.uuid|default:"—" }}</td>
      </tr>
      <tr>
        <th>Fecha de Timbrado</th>
        <th>Folio de Factura</th>
      </tr>
      <tr>
        <td class="center">{{ stamp.date|default:"—" }}</td>
        <td class="center hl">
          {{ raw.series|default:"" }}-{{ raw.folio_number|default:"—" }}
        </td>
      </tr>
      <tr>
        <th>No. Certificado SAT</th>
        <th>Lugar de Expedición</th>
      </tr>
      <tr>
        <td class="center">{{ stamp.sat_cert_number|default:"—" }}</td>
        <td class="center">
          {% if addr %}
            {{ addr.city|default:"—" }} {{ addr.state|default:"" }}
          {% else %}
            —
          {% endif %}
        </td>
      </tr>
      <tr>
        <th>RFC del PAC</th>
        <th>Fecha de Creación</th>
      </tr>
      <tr>
        <td class="center">{{ stamp.rfc_provider_cert|default:"—" }}</td>
        <td class="center">{{ carta.created_at|date:"d-m-Y H:i:s" }}</td>
      </tr>
    </table>

  </div>

  <!-- ===== Emisor / Receptor (DEBAJO del header) ===== -->
  <div class="box mb10" style="padding:0;">
    <table class="tbl">
      <thead>
        <tr>
          <th style="width:50%;">Emisor</th>
          <th style="width:50%;">Receptor</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <div><strong>{{ issuer.legal_name|default:"AUTO TRANSPORTES BASS" }}</strong></div>
            <div class="small"><strong>RFC:</strong> {{ issuer.tax_id|default:"—" }}</div>
            <div class="small"><strong>Régimen:</strong> ({{ issuer.tax_system|default:"—" }})</div>
          </td>
          <td>
            <div><strong>{{ cust.legal_name|default:"—" }}</strong></div>
            <div class="small"><strong>RFC:</strong> {{ cust.tax_id|default:"—" }}</div>
            <div class="small"><strong>Uso CFDI:</strong> ({{ raw.use|default:carta.uso_cfdi|default:"—" }})</div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ===== Costo del servicio + Totales ===== -->
  <div class="bar center">Costo del servicio</div>
  <div class="box mb10">
    <div class="cost-grid">

      <!-- Izquierda: concepto + cantidad con letra + leyendas -->
      <div>

        <!-- Concepto -->
        <div class="box mb10" style="padding:0; border-width:2px;">
          <table class="tbl">
            <thead>
              <tr>
                <th style="width:12%;">Cantidad</th>
                <th style="width:18%;">Unidad</th>
                <th>Concepto</th>
                <th style="width:18%;">Importe</th>
              </tr>
            </thead>
            <tbody>
              {% with qty=item.quantity|default:1 %}
              {% with price=prod.price|default:0 %}
              {% with discount=item.discount|default:0 %}
                {% widthratio discount 1 -1 as discount_neg %}
                {% with importe=importe_bruto|add:discount_neg %}
                <tr>
                  <td class="center">{{ qty }}</td>
                  <td class="center">[{{ prod.unit_key|default:"—" }}] {{ prod.unit_name|default:prod.unit_key|default:"—" }}</td>
                  <td>
                    <span class="nowrap">[{{ prod.product_key|default:"—" }}]</span>
                    {{ prod.description|default:"—" }}
                  </td>
                  <td class="right">{{ importe|floatformat:2|intcomma }}</td>
                </tr>
                {% endwith %}
              {% endwith %}{% endwith %}{% endwith %}
            </tbody>
          </table>
        </div>

        <!-- Cantidad con letra (NUEVA FILA y del TOTAL) -->
        <div class="amount-words mb10">
          <div class="label">Cantidad con letra</div>
          <div>
            {# No la tienes en BD: esto se debe calcular en Python y pasarla al template (ej: carta.total_words) #}
            — ({{ raw.currency|default:carta.currency|default:"MXN" }})
          </div>
        </div>

        <!-- Leyendas -->
        <div class="legend">
          IMPUESTO RETENIDO DE CONFORMIDAD CON LA LEY DEL IMPUESTO AL VALOR AGREGADO. EFECTOS FISCALES AL PAGO.
          <div class="warn">TODA MERCANCÍA VIAJA POR CUENTA Y RIESGO DEL CLIENTE POR NO TRAER SEGURO.</div>
          
        </div>

      </div>

      <!-- Derecha: Totales -->
      <div>
        {% with total=raw.total|default:0 %}
        {% with discount=item.discount|default:0 %}
          {# IVA (muy básico): si tax_included y hay IVA 16%, hacemos subtotal=total*100/116 e iva=total-subtotal #}
          {% with iva_rate=0 %}
            {% for t in taxes %}
              {% if t.type == "IVA" and not t.withholding and t.rate == 0.16 %}
                {% with iva_rate=16 %}{% endwith %}
              {% endif %}
            {% endfor %}

            {% if prod.tax_included and iva_rate %}
                {% widthratio subtotal_calc 1 -1 as subtotal_neg %}
                {% with iva_calc=total|add:subtotal_neg %}
                <table class="totals">
                  <tr>
                    <th>Subtotal</th>
                    <td>{{ subtotal_calc|floatformat:2|intcomma }}</td>
                  </tr>
                  <tr>
                    <th>Descuento</th>
                    <td>{{ discount|floatformat:2|intcomma }}</td>
                  </tr>
                  <tr>
                    <th>IVA</th>
                    <td>{{ iva_calc|floatformat:2|intcomma }}</td>
                  </tr>
                  <tr>
                    <th>Retención</th>
                    <td>{{ 0|floatformat:2|intcomma }}</td>
                  </tr>
                  <tr class="grand">
                    <th>Total</th>
                    <td>{{ total|floatformat:2|intcomma }}</td>
                  </tr>
                </table>
              {% endwith %}
            {% else %}
              <table class="totals">
                <tr>
                  <th>Subtotal</th>
                  <td>{{ total|floatformat:2|intcomma }}</td>
                </tr>
                <tr>
                  <th>Descuento</th>
                  <td>{{ discount|floatformat:2|intcomma }}</td>
                </tr>
                <tr>
                  <th>IVA</th>
                  <td>{{ 0|floatformat:2|intcomma }}</td>
                </tr>
                <tr>
                  <th>Retención</th>
                  <td>{{ 0|floatformat:2|intcomma }}</td>
                </tr>
                <tr class="grand">
                  <th>Total</th>
                  <td>{{ total|floatformat:2|intcomma }}</td>
                </tr>
              </table>
            {% endif %}
          {% endwith %}
        {% endwith %}{% endwith %}
      </div>

    </div>
  </div>

  <!-- ===== Observaciones ===== -->
  <div class="bar">Observaciones</div>
  <div class="box mb10">
    <div class="small">
      {{ carta.trip.observations|default:"—" }}
    </div>
  </div>

  <!-- ===== Pagaré ===== -->
  <div class="pagare">
    Por este pagaré me (nos) comprometo(emos) incondicionalmente a pagar a la orden de AUTO TRANSPORTES BASS,
    30 días después de la expedición de la carta porte que ampara la cantidad arriba citada, en LA PIEDAD , MICHOACAN.
    Si a su vencimiento no fuera pagado este pagaré, causará intereses moratorios del 2% mensual todo el tiempo que
    permanezca parcial o totalmente insoluto, sin que por ello se entienda prorrogado el plazo
  </div>

  <!-- ===== QR + sellos (al final) ===== -->
  <div class="footer-wrap">

    <div class="qr">
      <div class="tiny muted mb6"></div>
      {% with qr=qr_data_uri  %}
        {% if qr %}
          <img src="{{ qr }}" alt="QR SAT" />
        {% else %}
          <div class="tiny muted">No QR configured</div>
        {% endif %}
      {% endwith %}
    </div>

    <div class="seal-block">
      <div class="seal-title">Cadena original del complemento de certificación digital del SAT</div>
      <div class="mono">{{ stamp.complement_string|default:"—" }}</div>

      <div class="seal-title mt10">Sello digital del emisor</div>
      <div class="mono">{{ stamp.signature|default:"—" }}</div>

      <div class="seal-title mt10">Sello digital del SAT</div>
      <div class="mono">{{ stamp.sat_signature|default:"—" }}</div>
    </div>

  </div>

  <div class="page-foot">
    Este documento es una representación impresa de un CFDI
  </div>

  <div class="page-break"></div>

  <!-- =========================================================
       PAGE 2 (las demás páginas quedan como las tenías)
  ========================================================== -->

  <!-- ===== Header (igual) ===== -->
  <div class="header-wrap">

    <div class="brand-card">
      <div class="brand-logo-row">
        <img class="brand-logo" src="{% static 'img/basslogo.png' %}" alt="BASS" />
      </div>

      <div class="brand-title-row">
        <div class="brand-name">AUTO TRANSPORTES BASS</div>
        <div class="brand-sub">SERVICIO PUBLICO FEDERAL ESPECIALIZADO EN REFRIGERACION</div>
      </div>

      <div class="brand-meta">
        {% if addr %}
          {{ addr.street|default:"" }} {{ addr.exterior|default:"" }}{% if addr.interior %} INT {{ addr.interior }}{% endif %},
          {{ addr.neighborhood|default:"" }}<br/>
          {{ addr.city|default:"" }}, {{ addr.state|default:"" }} CP {{ addr.zip|default:"" }}
        {% else %}
          CHILPANCINGO 962 INT 1 COL. JARDINES DEL CARMEN<br/>LA PIEDAD, MICHOACAN CP 59389
        {% endif %}
        <br/>
        <span class="muted">Tel:</span> {{ carta.response_snapshot.emisor_tel|default:"352 688 0736" }}<br/>
        <span class="muted">Email:</span> {{ carta.response_snapshot.emisor_email|default:"atencion.clientes@autotransportesbass.com" }}
      </div>
    </div>

    <table class="cert-table">
      <tr>
        <th>Certificado del Emisor</th>
        <th>Folio Fiscal Complemento(UUID)</th>
      </tr>
      <tr>
        <td class="center">—</td>
        <td class="center">{{ raw.uuid|default:carta.uuid|default:"—" }}</td>
      </tr>
      <tr>
        <th>Fecha de Timbrado</th>
        <th>Folio de Factura</th>
      </tr>
      <tr>
        <td class="center">{{ stamp.date|default:"—" }}</td>
        <td class="center hl">{{ raw.series|default:"" }}-{{ raw.folio_number|default:"—" }}</td>
      </tr>
      <tr>
        <th>No. Certificado SAT</th>
        <th>Lugar de Expedición</th>
      </tr>
      <tr>
        <td class="center">{{ stamp.sat_cert_number|default:"—" }}</td>
        <td class="center">
          {% if addr %}
            {{ addr.city|default:"—" }} {{ addr.state|default:"" }}
          {% else %}
            —
          {% endif %}
        </td>
      </tr>
      <tr>
        <th>RFC del PAC</th>
        <th>Fecha de Creación</th>
      </tr>
      <tr>
        <td class="center">{{ stamp.rfc_provider_cert|default:"—" }}</td>
        <td class="center">{{ carta.created_at|date:"d-m-Y H:i:s" }}</td>
      </tr>
    </table>

  </div>

  <!-- ===== Origen / Destino ===== -->
  <div class="bar">Origen/Destino</div>
  <div class="box mb10">
    <div class="grid-2">
      <div>
        {% for u in carta.locations.all %}
          {% if u.tipo_ubicacion == "Origen" %}
            <div><strong>{{ u.nombre|default:"—" }}</strong></div>
            <div class="small"><strong>RFC:</strong> {{ u.rfc }}</div>
            <div class="small">
              {{ u.calle|default:"" }} {{ u.numero_exterior|default:"" }}
              {% if u.numero_interior %} INT {{ u.numero_interior }}{% endif %}<br/>
              {{ u.municipio|default:"" }}, {{ u.estado|default:"" }}, {{ u.pais }} CP {{ u.codigo_postal }}
            </div>
            <div class="small mt8"><strong>SALIDA:</strong> {{ carta.fecha_salida|date:"d-m-Y H:i:s" }}</div>
          {% endif %}
        {% endfor %}
      </div>

      <div>
        {% for u in carta.locations.all %}
          {% if u.tipo_ubicacion == "Destino" %}
            <div><strong>{{ u.nombre|default:"—" }}</strong></div>
            <div class="small"><strong>RFC:</strong> {{ u.rfc }}</div>
            <div class="small">
              {{ u.calle|default:"" }} {{ u.numero_exterior|default:"" }}
              {% if u.numero_interior %} INT {{ u.numero_interior }}{% endif %}<br/>
              {{ u.municipio|default:"" }}, {{ u.estado|default:"" }}, {{ u.pais }} CP {{ u.codigo_postal }}
            </div>
            <div class="small mt8"><strong>FECHA O PLAZO PREVISTO DE ENTREGA:</strong> {{ carta.fecha_llegada|date:"d-m-Y H:i:s" }}</div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- ===== Mercancía ===== -->
  <div class="bar center">Mercancía transportada</div>
  <div class="box mb10" style="padding:0;">
    <table class="tbl">
      <thead>
        <tr>
          <th style="width:14%;">Cantidad</th>
          <th style="width:18%;">Unidad</th>
          <th style="width:18%;">Clave</th>
          <th>Mercancía</th>
          <th style="width:14%;">Peso (kg)</th>
          <th style="width:16%;">Frac. Aranc.</th>
        </tr>
      </thead>
      <tbody>
        {% for g in carta.goods.all %}
          <tr>
            <td class="right">{{ g.cantidad }}</td>
            <td>{{ g.unidad|default:"—" }}{% if g.embalaje %} ({{ g.embalaje }}){% endif %}</td>
            <td>
              {% if g.mercancia %}{{ g.mercancia.clave }}{% else %}—{% endif %}
            </td>
            <td>
              {% if g.mercancia %}{{ g.mercancia.nombre }}{% else %}—{% endif %}
            </td>
            <td class="right">{{ g.peso_en_kg|default:"—" }}</td>
            <td>
              {% if g.mercancia and g.mercancia.fraccion_arancelaria %}
                {{ g.mercancia.fraccion_arancelaria }}
              {% else %}
                {{ g.pedimento|default:"—" }}
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="6" class="center muted">No goods captured</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ===== Operador/Vehículo/Caja/Seguro ===== -->
     <div class="bar center">Figura Transporte</div>

  <div class="box mb10" style="padding:0;">
    <table class="tbl">
      <thead>
        <tr>
          <th>Operador</th>
          <th>Vehículo</th>
          <th>Caja</th>
          <th>Seguro</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <div class="small"><strong>NOMBRE</strong> &nbsp; {{ carta.trip.operator }}</div>
            <div class="small"><strong>RFC</strong> &nbsp; {{ carta.trip.operator.rfc|default:"—" }}</div>
            <div class="small"><strong>LICENCIA</strong> &nbsp; {{ carta.trip.operator.licencia|default:"—" }}</div>
          </td>
          <td>
            <div class="small"><strong>Eco</strong> &nbsp; {{ carta.trip.truck.numero_economico|default:carta.trip.truck }}</div>
            <div class="small"><strong>Placa</strong> &nbsp; {{ carta.trip.truck.placa|default:"—" }}</div>
          </td>
          <td>
            <div class="small"><strong>Eco</strong> &nbsp; {{ carta.trip.reefer_box.numero_economico|default:carta.trip.reefer_box }}</div>
            <div class="small"><strong>Placa</strong> &nbsp; {{ carta.trip.reefer_box.placa|default:"—" }}</div>
          </td>
          <td>
            <div class="small"><strong>Compañía</strong> &nbsp; {{ carta.response_snapshot.seguro_compania|default:"—" }}</div>
            <div class="small"><strong>Póliza Tracto</strong> &nbsp; {{ carta.response_snapshot.poliza_tracto|default:"—" }}</div>
            <div class="small"><strong>Póliza Caja</strong> &nbsp; {{ carta.response_snapshot.poliza_caja|default:"—" }}</div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ===== Información General ===== -->
  <div class="bar center">Información General</div>
  <div class="box mb10">
    <div class="grid-2">
      <div>
        <div class="small"><strong>NUM. PEDIMENTO</strong> &nbsp; {{ carta.pedimento|default:"—" }}</div>
        <div class="small"><strong>SELLO No.</strong> &nbsp; {{ carta.response_snapshot.sello_no|default:"—" }}</div>
        <div class="small"><strong>NUM. ORDEN</strong> &nbsp; {{ carta.orden|default:"—" }}</div>
        <div class="small"><strong>FACTURA CLIENTE</strong> &nbsp; {{ carta.response_snapshot.factura_cliente|default:"—" }}</div>
        <div class="small"><strong>FECHA CARGA</strong> &nbsp; {{ carta.fecha_salida|date:"d-m-Y H:i:s" }}</div>
        <div class="small"><strong>TEMPERATURA</strong> &nbsp; {{ carta.trip.temperatura_max|default:"—" }} {{ carta.trip.temp_scale }}</div>
        <div class="small"><strong>CONFIGURACION</strong> &nbsp; {{ carta.response_snapshot.configuracion|default:"—" }}</div>
        <div class="small"><strong>VALOR DECLARADO</strong> &nbsp; {{ carta.response_snapshot.valor_declarado|default:"0.00" }} {{ carta.currency }}</div>
        <div class="small"><strong>INDEMNIZACION EN CASO DE SINIESTRO</strong> &nbsp; {{ carta.response_snapshot.indemnizacion|default:"NO APLICA" }}</div>
        <div class="small"><strong>MATERIAL O RESIDUO PELIGROSO</strong> &nbsp; {{ carta.response_snapshot.peligroso|default:"NO (X)" }}</div>
      </div>

      <div>
        <div class="small"><strong>VERSION CFDI</strong> &nbsp; {{ raw.cfdi_version|default:"4.0" }}</div>
        <div class="small"><strong>USO CFDI</strong> &nbsp; ({{ raw.use|default:carta.uso_cfdi|default:"—" }})</div>
        <div class="small"><strong>REGIMEN FISCAL</strong> &nbsp; ({{ issuer.tax_system|default:"—" }})</div>
        <div class="small"><strong>TIPO DE COMPROBANTE</strong> &nbsp; ({{ raw.type|default:carta.type|default:"—" }})</div>
        <div class="small"><strong>METODO DE PAGO</strong> &nbsp; ({{ raw.payment_method|default:carta.payment_method|default:"—" }})</div>
        <div class="small"><strong>FORMA DE PAGO</strong> &nbsp; ({{ raw.payment_form|default:carta.payment_form|default:"—" }})</div>
        <div class="small"><strong>NUM. CTA. PAGO</strong> &nbsp; {{ carta.response_snapshot.num_cta_pago|default:"POR DEFINIR" }}</div>
        <div class="small"><strong>MONEDA</strong> &nbsp; ({{ raw.currency|default:carta.currency|default:"—" }})</div>
        <div class="small"><strong>CFDI RELACIONADO</strong> &nbsp; {{ carta.response_snapshot.cfdi_relacionado|default:"[]" }}</div>
        <div class="small"><strong>TIPO DE RELACION</strong> &nbsp; {{ carta.response_snapshot.tipo_relacion|default:"—" }}</div>
      </div>
    </div>
  </div>

  <!-- ===== QR + sellos (al final) ===== -->
  <div class="footer-wrap">

    <div class="qr">
      <div class="tiny muted mb6"></div>
      {% with qr=qr_data_uri  %}
        {% if qr %}
          <img src="{{ qr }}" alt="QR SAT" />
        {% else %}
          <div class="tiny muted">No QR configured</div>
        {% endif %}
      {% endwith %}
    </div>

    <div class="seal-block">
      <div class="seal-title">Cadena original del complemento de certificación digital del SAT</div>
      <div class="mono">{{ stamp.complement_string|default:"—" }}</div>

      <div class="seal-title mt10">Sello digital del emisor</div>
      <div class="mono">{{ stamp.signature|default:"—" }}</div>

      <div class="seal-title mt10">Sello digital del SAT</div>
      <div class="mono">{{ stamp.sat_signature|default:"—" }}</div>
    </div>

  </div>

  <div class="page-foot">
    Este documento es una representación impresa de un CFDI
  </div>

  <div class="page-break"></div>

  <!-- ===== Condiciones del contrato ===== -->
  <div class="bar">CONDICIONES DEL CONTRATO DE TRANSPORTE QUE AMPARA ESTA CARTA PORTE</div>
  <div class="box">
    <div class="tiny" style="line-height:1.25;">
      PRIMERA.- Para los efectos del presente contrato de transporte se denomina ´´Transportista´´ al que realiza el servicio de transportación y ´´Remitente´´ o ´´Expedidor´´
      al usuario que contrate el servicio o remite la mercancía.
      SEGUNDA.- El ´´Remitente´´ o ´´Expedidor´´ es responsable de que la información proporcionada al ´´Transportista´´ sea veraz y que la documentación que entregue
      para efectos del transporte sea la correcta.
      TERCERA.- El ´´Remitente´´ o ´´Expedidor´´ debe declarar al ´´Transportista´´ el tipo de mercancía o efectos de que se trate, peso, medidas y/o número de la carga que
      entrega para su transporte y, en su caso, el valor de la misma. La carga que se entregue a granel será pesada por el ´´Transportista´´ en el primer punto donde haya
      báscula apropiada o, en su defecto, aforada en metros cúbicos con la conformidad del ´´Remitente´´ o ´´Expedidor´´.
      CUARTA.- Para efectos del transporte, el ´´Remitente´´ o ´´Expedidor´´ deberá entregar al ´´Transportista´´ los documentos que las leyes y reglamentos exijan para llevar
      a cabo el servicio, en caso de no cumplirse con estos requisitos el ´´Transportista´´ está obligado a rehusar el transporte de las mercancías.
      QUINTA.- Si por sospecha de falsedad en la declaración del contenido de un bulto el ´´Transportista´´ deseare proceder a su reconocimiento, podrá hacerlo ante
      testigos y con la asistencia del ´´Remitente´´ o ´´Expedidor´´ o del consignatario. Si este último no concurriere, se solicitará la presencia de un inspector de la Secretaría
      de Comunicaciones y Transportes, y se levantará el acta correspondiente. El ´´Transportista´´ tendrá en todo caso, la obligación de dejar los bultos en el estado que se
      encontraban antes del reconocimiento.
      SEXTA.- El ´´Transportista´´ deberá recoger y entregar la carga precisamente en los domicilios que señale el ´´Remitente´´ o ´´Expedidor´´, ajustándose a los términos y
      condiciones convenidos. El ´´Transportista´´ sólo está obligado a llevar la carga al domicilio del consignatario para su entrega una sola vez. Si ésta no fuera recibida, se
      dejará aviso de que la mercancía queda a disposición del interesado en las bodegas que indique el ´´Transportista´´.
      SÉPTIMA.- Si la carga no fuere retirada dentro de los 30 días hábiles siguientes a aquel en que hubiere sido puesta a disposición del consignatario, el ´´Transportista´´
      podrá solicitar la venta en subasta pública con arreglo a lo que dispone el Código de Comercio.
      OCTAVA.- El ´´Transportista´´ y el ´´Remitente´´ o ´´Expedidor´´ negociarán libremente el precio del servicio, tomando en cuenta su tipo, característica delos embarques,
      volumen, regularidad, clase de carga y sistema de pago.
      NOVENA.- Si el ´´Remitente´´ o ´´Expedidor´´ desea que el ´´Transportista´´ asuma la responsabilidad por el valor de las mercancías o efectos que él declare y que cubra
      toda clase de riesgos, inclusive los derivados de caso fortuito o de fuerza mayor, las partes deberán convenir un cargo adicional, equivalente al valor de la prima de
      seguro que se contrate, el cual se deberá expresar en la Carta de Porte.
      DÉCIMA.- Cuando el importe del flete no incluya el cargo adicional, la responsabilidad del ´´Transportista´´ queda expresamente limitada a la cantidad equivalente a 15
      días de salario mínimo vigente en el Distrito Federal por tonelada o cuando se trate de embarques cuyo peso sea mayor de 200 kg., pero menor de 1000 kg.; y a 4 días
      de salario mínimo por remesa cuando se trate de embarques con peso hasta de 200 kg.
      DÉCIMA PRIMERA.- El precio del transporte deberá pagarse en origen, salvo convenio entre las partes de pago en destino. Cuando el transporte se hubiere concertado
      ´´Flete por cobrar´´, la entrega de las mercancías o efectos se hará contra el pago del flete y el ´´Transportista´´ tendrá derecho a retenerlos mientras no se cubra el
      precio retenido.
      DÉCIMA SEGUNDA.- Si al momento de la entrega resultare algún faltante o avería, el consignatario deberá hacerla constar en ese acto en la Carta de Porte y formular
      su reclamación por escrito al ´´Transportista´´, dentro de las 24 horas siguientes.
      DÉCIMA TERCERA.- El ´´Transportista´´ queda eximido de la obligación de recibir mercancías o efectos para su transporte en los siguientes casos: a) Cuando se trate
      de carga que por su naturaleza, peso, volumen, embalaje defectuoso o cualquier otra circunstancia no pueda transportarse sin destruirse o sin causar daño a los
      demás artículos o al material rodante, salvo que la empresa de que se trate tenga el equipo adecuado. B) Las mercancías cuyo transporte haya sido prohibido por
      disposiciones legales o reglamentarias. Cuando tales disposiciones no prohíban precisamente el transporte de determinadas mercancías, pero sí ordenen la
      presentación de ciertos documentos para que puedan ser transportadas, el ´´Remitente´´ o ´´Expedidor´´ estará obligado a entregar al ´´Transportista´´ los documentos
      correspondientes.
      DÉCIMA CUARTA.- Los casos no previstos en las presentes condiciones y las quejas derivadas de su aplicación se someterán por la vía administrativa a la Secretaría
      de Comunicaciones y Transportes.
      DÉCIMA QUINTA.- Para el caso de que el ´´Remitente´´ o ´´Expedidor´´ contrate carro por entero, éste aceptará la responsabilidad solidaria para con el ´´Transportista´´
      mediante la figura de la corresponsabilidad que contempla el artículo 10 del Reglamento Sobre el Peso, Dimensiones y Capacidad de los Vehículos de Autotransporte
      que Transitan en los Caminos y Puentes de Jurisdicción Federal, por lo que el ´´Remitente´´ o ´´Expedidor´´ queda obligado a verificar que la carga y el vehículo que la
      transporta, cumplan con el peso y dimensiones máximas establecidos en la NOM-012-SCT-2-2014.
      Para el caso de incumplimiento o inobservancia a las disposiciones que regulan el peso y dimensiones, por parte del ´´Remitente´´ o ´´Expedidor´´, este será
      corresponsable de las infracciones y multas que la Secretaría de Comunicaciones y Transportes y la Policía Federal impongan al ´´Transportista´´ por cargar las
      unidades con exceso de peso.
    </div>
  </div>

  <!-- ===== QR + sellos (al final) ===== -->
  <div class="footer-wrap">

    <div class="qr">
      <div class="tiny muted mb6"></div>
      {% with qr=qr_data_uri  %}
        {% if qr %}
          <img src="{{ qr }}" alt="QR SAT" />
        {% else %}
          <div class="tiny muted">No QR configured</div>
        {% endif %}
      {% endwith %}
    </div>

    <div class="seal-block">
      <div class="seal-title">Cadena original del complemento de certificación digital del SAT</div>
      <div class="mono">{{ stamp.complement_string|default:"—" }}</div>

      <div class="seal-title mt10">Sello digital del emisor</div>
      <div class="mono">{{ stamp.signature|default:"—" }}</div>

      <div class="seal-title mt10">Sello digital del SAT</div>
      <div class="mono">{{ stamp.sat_signature|default:"—" }}</div>
    </div>

  </div>

  <div class="page-foot">
    Este documento es una representación impresa de un CFDI
  </div>

{% endwith %} {# stamp #}
{% endwith %} {# taxes #}
{% endwith %} {# prod #}
{% endwith %} {# item #}
{% endwith %} {# cust #}
{% endwith %} {# addr #}
{% endwith %} {# issuer_addr #}
{% endwith %} {# issuer #}
{% endwith %} {# raw #}
</body>
</html>
