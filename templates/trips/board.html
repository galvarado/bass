{% extends "base.html" %}
{% block title %}Monitoreo de viajes · BASS{% endblock %}

{% block content %}

<style>
  /* ===== TABLERO GENERAL ===== */

  .kanban-board {
    gap: 1.5rem;
    padding: 0.5rem 0.75rem;
  }

  .kanban-column {
    background: #ffffff;
    border-radius: 0.5rem;
    border: 1px solid #e3e6f0;
    padding: 0.5rem 0.5rem 1rem;
    min-width: 260px;
    display: flex;
    flex-direction: column;
    min-height: calc(100vh - 220px); /* altura completa del tablero */
  }

  .kanban-header {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 0.35rem;
  }

  .kanban-column-body {
    margin-top: 0.6rem;
    padding-right: 0.25rem;
    flex: 1;
    overflow-y: auto;
  }

  .kanban-column-body.kanban-column-over {
    outline: 2px dashed #124174;
    outline-offset: -4px;
    background: #e8f0ff;
  }

  /* ===== TARJETAS DE VIAJE (DISEÑO PREMIUM AZUL) ===== */

  .kanban-trip-card {
    background: linear-gradient(135deg, #124174 0%, #124174 100%);
    color: white;
    border-radius: 0.75rem;
    padding: 0.55rem 0.65rem !important;
    margin-bottom: 0.75rem;
    cursor: grab;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    transition: transform 0.12s ease, box-shadow 0.12s ease;

    /* mismo tamaño para todas */
    min-height: 170px;
    display: flex;
    flex-direction: column;
  }

  .kanban-trip-card.dragging {
    opacity: 0.7;
    cursor: grabbing;
    transform: scale(0.98);
  }

  .kanban-trip-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 18px rgba(0,0,0,0.22);
  }

  .ktc-title {
    font-size: 0.95rem;
    font-weight: 700;
    letter-spacing: 0.3px;
  }

  .ktc-body {
    margin-top: 0.25rem !important;
    margin-bottom: 0.15rem !important;
    padding: 0 !important;
    font-size: 0.85rem;
    line-height: 1.2rem;
    flex: 1; /* empuja el footer al fondo para todas */
  }

  .ktc-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.15rem;
    color: rgba(255, 255, 255, 0.85);
    line-height: 1.1rem;
  }

  .ktc-icon {
    width: 16px;
    margin-right: 6px;
    opacity: 0.9;
  }

  .ktc-footer {
    margin-top: 0.1rem;
  }

  /* Botón lupa refinado y compacto */
  .ktc-btn {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(3px);
    border-radius: 50%;
    padding: 4px 6px;
    color: white !important;
    font-size: 0.65rem;
    width: 26px;
    height: 26px;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.15s ease;
  }

  .ktc-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: scale(1.08);
  }
</style>


<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Monitoreo de viajes</h1>
  <small class="text-muted">Tablero del {{ today|date:"d/m/Y" }}</small>
</div>

<!-- SIN CARD, solo el board -->
<div class="kanban-board d-flex flex-row flex-nowrap overflow-auto">

  <!-- PROGRAMADO -->
  <div class="kanban-column flex-shrink-0">
    <div class="kanban-header bg-warning text-dark px-3 py-2">
      PROGRAMADO
      <span class="badge badge-light ml-1" data-counter="PROGRAMADO">{{ programados|length }}</span>
    </div>
    <div class="kanban-column-body" data-status="PROGRAMADO">
      {% for trip in programados %}
        {% include "trips/partials/_trip_card.html" with trip=trip %}
      {% empty %}
        <div class="text-muted small px-2 kanban-empty">
          Sin viajes en programados.
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- EN ORIGEN -->
  <div class="kanban-column flex-shrink-0">
    <div class="kanban-header bg-info text-white px-3 py-2">
      EN ORIGEN
      <span class="badge badge-light ml-1" data-counter="EN_ORIGEN">{{ en_origen|length }}</span>
    </div>
    <div class="kanban-column-body" data-status="EN_ORIGEN">
      {% for trip in en_origen %}
        {% include "trips/partials/_trip_card.html" with trip=trip %}
      {% empty %}
        <div class="text-muted small px-2 kanban-empty">
          Sin viajes en origen.
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- EN CURSO -->
  <div class="kanban-column flex-shrink-0">
    <div class="kanban-header bg-primary text-white px-3 py-2">
      EN CURSO
      <span class="badge badge-light ml-1" data-counter="EN_CURSO">{{ en_curso|length }}</span>
    </div>
    <div class="kanban-column-body" data-status="EN_CURSO">
      {% for trip in en_curso %}
        {% include "trips/partials/_trip_card.html" with trip=trip %}
      {% empty %}
        <div class="text-muted small px-2 kanban-empty">
          Sin viajes en curso.
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- EN DESTINO -->
  <div class="kanban-column flex-shrink-0">
    <div class="kanban-header bg-success text-white px-3 py-2">
      EN DESTINO
      <span class="badge badge-light ml-1" data-counter="EN_DESTINO">{{ en_destino|length }}</span>
    </div>
    <div class="kanban-column-body" data-status="EN_DESTINO">
      {% for trip in en_destino %}
        {% include "trips/partials/_trip_card.html" with trip=trip %}
      {% empty %}
        <div class="text-muted small px-2 kanban-empty">
          Sin viajes en destino.
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- COMPLETADO (hoy) -->
  <div class="kanban-column flex-shrink-0">
    <div class="kanban-header bg-secondary text-white px-3 py-2">
      COMPLETADO (hoy)
      <span class="badge badge-light ml-1" data-counter="COMPLETADO">{{ completados|length }}</span>
    </div>
    <div class="kanban-column-body" data-status="COMPLETADO">
      {% for trip in completados %}
        {% include "trips/partials/_trip_card.html" with trip=trip %}
      {% empty %}
        <div class="text-muted small px-2 kanban-empty">
          Sin viajes completados.
        </div>
      {% endfor %}
    </div>
  </div>

</div>

<!-- Modal de Notificación -->
<div class="modal fade" id="notifModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0" style="border-radius: 12px;">
      <div class="modal-header bg-danger text-white py-2" id="notifModalHeader">
        <h6 class="modal-title mb-0" id="notifModalTitle">Error</h6>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body py-3" id="notifModalBody">
        Texto del mensaje
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-sm btn-primary" data-dismiss="modal">
          Entendido
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Hora de llegada a origen -->
<div class="modal fade" id="arrivalOriginModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title" id="timeModalTitle">Hora</h6>
        <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body py-2">
        <div class="form-group mb-2">
          <label for="arrivalOriginInput" class="small mb-1" id="timeModalLabel">
            Fecha y hora
          </label>
          <input type="datetime-local"
                 id="arrivalOriginInput"
                 class="form-control form-control-sm">
        </div>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-sm btn-light" id="arrivalOriginCancelBtn">
          Cancelar
        </button>
        <button type="button" class="btn btn-sm btn-primary" id="arrivalOriginSaveBtn">
          Guardar
        </button>
      </div>
    </div>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const cards = document.querySelectorAll(".kanban-trip-card");
    const columns = document.querySelectorAll(".kanban-column-body");

    // ===== ORDEN ESTRICTO DE ESTADOS =====
    const STATUS_FLOW = ["PROGRAMADO", "EN_ORIGEN", "EN_CURSO", "EN_DESTINO", "COMPLETADO"];

    // Movimiento pendiente cuando se requiere hora
    let pendingMove = null;

    // ===== Helpers =====

    function showNotif(message, type="error") {
        const modalTitle = document.getElementById("notifModalTitle");
        const modalBody = document.getElementById("notifModalBody");
        const modalHeader = document.getElementById("notifModalHeader");

        modalBody.textContent = message;

        if (type === "error") {
            modalTitle.textContent = "Error";
            modalHeader.className = "modal-header bg-danger text-white py-2";
        } else if (type === "warning") {
            modalTitle.textContent = "Advertencia";
            modalHeader.className = "modal-header";
        } else {
            modalTitle.textContent = "Información";
            modalHeader.className = "modal-header bg-primary text-white py-2";
        }

        $('#notifModal').modal('show');
    }


    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function recalcCounters() {
      const counters = document.querySelectorAll("[data-counter]");
      counters.forEach(c => {
        const status = c.getAttribute("data-counter");
        const col = document.querySelector('.kanban-column-body[data-status="' + status + '"]');
        if (!col) return;
        c.textContent = col.querySelectorAll(".kanban-trip-card").length;
      });
    }

    function updateEmptyMessages() {
      columns.forEach(col => {
        const cardsInCol = col.querySelectorAll(".kanban-trip-card").length;
        const emptyNode = col.querySelector(".kanban-empty");
        const status = col.dataset.status;

        if (cardsInCol > 0) {
          if (emptyNode) emptyNode.remove();
        } else {
          if (!emptyNode) {
            const msg = document.createElement("div");
            msg.className = "text-muted small px-2 kanban-empty";

            let text = "Sin viajes.";
            if (status === "PROGRAMADO") text = "Sin viajes programados.";
            else if (status === "EN_ORIGEN") text = "Sin viajes en origen.";
            else if (status === "EN_CURSO") text = "Sin viajes en curso.";
            else if (status === "EN_DESTINO") text = "Sin viajes en destino.";
            else if (status === "COMPLETADO") text = "Sin viajes completados hoy.";

            msg.textContent = text;
            col.appendChild(msg);
          }
        }
      });
    }

    // ===== Drag & Drop tarjetas =====

    function attachCardDrag(card) {
      card.addEventListener("dragstart", function (e) {
        e.dataTransfer.setData("text/plain", card.dataset.tripId);
        e.dataTransfer.effectAllowed = "move";
        card.classList.add("dragging");
      });
      card.addEventListener("dragend", function () {
        card.classList.remove("dragging");
      });
    }

    cards.forEach(attachCardDrag);

    columns.forEach(col => {
      col.addEventListener("dragover", function (e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
        col.classList.add("kanban-column-over");
      });

      col.addEventListener("dragleave", function () {
        col.classList.remove("kanban-column-over");
      });

      col.addEventListener("drop", function (e) {
        e.preventDefault();
        col.classList.remove("kanban-column-over");

        const tripId = e.dataTransfer.getData("text/plain");
        const newStatus = col.dataset.status;
        const card = document.querySelector('.kanban-trip-card[data-trip-id="' + tripId + '"]');

        if (!card || !newStatus) return;

        const fromCol = card.closest(".kanban-column-body");
        const oldStatus = card.dataset.status;

        // Si no cambió de status, solo reordenar
        if (oldStatus === newStatus) {
          col.prepend(card);
          updateEmptyMessages();
          return;
        }

        // ===== VALIDACIÓN DE FLUJO =====
        const fromIdx = STATUS_FLOW.indexOf(oldStatus);
        const toIdx   = STATUS_FLOW.indexOf(newStatus);

        if (fromIdx === -1 || toIdx === -1) {
          showNotif("Estatus de viaje inválido.", "error");
          return;
        }

        if (toIdx < fromIdx) {
          showNotif("No puedes regresar un viaje a un estado anterior.", "warning");
          return;
        }

        if (toIdx > fromIdx + 1) {
          showNotif("No puedes saltar estados. El siguiente estado válido es: " + STATUS_FLOW[fromIdx + 1], "warning");
          return;
        }

        // ===== STATUS QUE REQUIEREN HORA =====
        const needsTime = ["EN_ORIGEN", "EN_CURSO", "EN_DESTINO"].includes(newStatus);

        if (needsTime) {
          pendingMove = {
            tripId,
            card,
            fromCol,
            toCol: col,
            oldStatus,
            newStatus,
            field: null,
          };

          const labelEl = document.getElementById("timeModalLabel");
          const titleEl = document.getElementById("timeModalTitle");

          if (newStatus === "EN_ORIGEN") {
            pendingMove.field = "arrival_origin_at";
            titleEl.textContent = "Hora de llegada al origen";
            labelEl.textContent = "Fecha y hora de llegada al origen";
          } else if (newStatus === "EN_CURSO") {
            pendingMove.field = "departure_origin_at";
            titleEl.textContent = "Hora de salida del origen";
            labelEl.textContent = "Fecha y hora de salida del origen";
          } else if (newStatus === "EN_DESTINO") {
            pendingMove.field = "arrival_destination_at";
            titleEl.textContent = "Hora de llegada al destino";
            labelEl.textContent = "Fecha y hora de llegada al destino";
          }

          // Mover visualmente
          col.prepend(card);
          card.dataset.status = newStatus;
          recalcCounters();
          updateEmptyMessages();

          // Set default datetime
          const input = document.getElementById("arrivalOriginInput");
          if (input) {
            const now = new Date();
            const pad = n => n.toString().padStart(2, "0");
            input.value =
              now.getFullYear() + "-" +
              pad(now.getMonth() + 1) + "-" +
              pad(now.getDate()) + "T" +
              pad(now.getHours()) + ":" +
              pad(now.getMinutes());
          }

          $('#arrivalOriginModal').modal('show');
          return;
        }

        // ===== Flujo normal (sin hora) =====
        col.prepend(card);
        card.dataset.status = newStatus;
        recalcCounters();
        updateEmptyMessages();

        fetch("{% url 'trips:change_status' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({
            trip_id: tripId,
            status: newStatus,
          }),
        })
          .then(resp => resp.json())
          .then(data => {
            if (!data.ok) {
              showNotif("No se pudo actualizar el estatus.", "error");
              window.location.reload();
            }
          })
          .catch(err => {
            showNotif("Error de comunicación con el servidor.", "error");
            window.location.reload();
          });
      });
    });

    // ===== Modal =====

    const modalEl = document.getElementById("arrivalOriginModal");
    const saveBtn = document.getElementById("arrivalOriginSaveBtn");
    const cancelBtn = document.getElementById("arrivalOriginCancelBtn");

    function revertPendingMove() {
      if (!pendingMove) return;
      const { card, fromCol, oldStatus } = pendingMove;
      fromCol.prepend(card);
      card.dataset.status = oldStatus;
      pendingMove = null;
      recalcCounters();
      updateEmptyMessages();
    }

    if (cancelBtn) {
      cancelBtn.addEventListener("click", function () {
        $('#arrivalOriginModal').modal('hide');
        revertPendingMove();
      });
    }

    if (modalEl) {
      $('#arrivalOriginModal').on('hidden.bs.modal', function () {
        if (pendingMove) {
          revertPendingMove();
        }
      });
    }

    if (saveBtn) {
      saveBtn.addEventListener("click", function () {
        if (!pendingMove) {
          $('#arrivalOriginModal').modal('hide');
          return;
        }

        const input = document.getElementById("arrivalOriginInput");
        const value = input ? input.value : "";

        if (!value) {
          alert("Debes capturar la fecha y hora.");
          return;
        }

        const { tripId, newStatus, field } = pendingMove;

        const payload = {
          trip_id: tripId,
          status: newStatus,
        };

        payload[field] = value;

        fetch("{% url 'trips:change_status' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify(payload),
        })
          .then(resp => resp.json())
          .then(data => {
            if (!data.ok) {
              alert(data.error || "No se pudo actualizar el estatus.");
              revertPendingMove();
            } else {
              pendingMove = null;
              window.location.reload();
            }
            $('#arrivalOriginModal').modal('hide');
          })
          .catch(err => {
            alert("Error de comunicación.");
            revertPendingMove();
            $('#arrivalOriginModal').modal('hide');
          });
      });
    }

    updateEmptyMessages();
  });
</script>



{% endblock %}
