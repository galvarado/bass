{# templates/trips/form.html #}
{% extends "base.html" %}
{% load form_extras %}
{% block title %}{% if object %}Editar Viaje{% else %}Nuevo Viaje{% endif %} · BASS{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">{% if object %}Editar Viaje{% else %}Nuevo Viaje{% endif %}</h1>
  <a href="{% url 'trips:list' %}" class="btn btn-light btn-sm">
    <i class="fas fa-arrow-left"></i> Volver
  </a>
</div>

<form method="post" class="card shadow-sm form-compact">
  {% csrf_token %}
  <div class="card-body">

    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {% for e in form.non_field_errors %}{{ e }}<br>{% endfor %}
      </div>
    {% endif %}

    <!-- ===== DATOS DEL VIAJE ===== -->
    <h6 class="text-primary mb-2">
      <i class="fas fa-route mr-1"></i> Datos del viaje
    </h6>

    <div class="form-row">
      <div class="form-group col-md-5">
        <label for="{{ form.client.id_for_label }}">Cliente</label>
        {{ form.client|add_class:"form-control form-control-sm" }}
        <small class="text-muted">Primero elige el cliente para cargar sus rutas.</small>
      </div>

      <div class="form-group col-md-7">
        <label for="{{ form.route.id_for_label }}">Ruta</label>
        {{ form.route|add_class:"form-control form-control-sm" }}
      </div>
    </div>

    <!-- ===== ASIGNACIÓN ===== -->
    <hr>
    <h6 class="text-primary mb-2">
      <i class="fas fa-truck mr-1"></i> Asignación
    </h6>
    <div class="form-row">
      <div class="form-group col-md-4">
        <label for="{{ form.operator.id_for_label }}">Operador</label>
        {{ form.operator|add_class:"form-control form-control-sm" }}
      </div>
      <div class="form-group col-md-4">
        <label for="{{ form.truck.id_for_label }}">Camión</label>
        {{ form.truck|add_class:"form-control form-control-sm" }}
      </div>
      <div class="form-group col-md-4">
        <label for="{{ form.reefer_box.id_for_label }}">Caja</label>
        {{ form.reefer_box|add_class:"form-control form-control-sm" }}
      </div>
    </div>

    <!-- ===== DETALLES ===== -->
    <hr>
    <h6 class="text-primary mb-2">
      <i class="fas fa-exchange-alt mr-1"></i> Detalles
    </h6>

    <div class="form-row">
      <div class="form-group col-md-4">
        <label for="{{ form.clasificacion.id_for_label }}">Clasificación</label>
        {{ form.clasificacion|add_class:"form-control form-control-sm" }}
        {% if form.clasificacion.errors %}
          <div class="text-danger small mt-1">
            {% for e in form.clasificacion.errors %}{{ e }}<br>{% endfor %}
          </div>
        {% endif %}
      </div>
      <div class="form-group col-md-3">
        <label for="{{ form.transfer_operator.id_for_label }}">Transfer</label>
        {{ form.transfer_operator|add_class:"form-control form-control-sm" }}
        <input type="hidden" name="transfer_operator" id="transfer_operator_hidden" value="">

      </div>

      <div class="form-group col-md-5">
        <label for="{{ form.producto.id_for_label }}">Producto</label>
        {{ form.producto|add_class:"form-control form-control-sm" }}
        {% if form.producto.errors %}
          <div class="text-danger small mt-1">
            {% for e in form.producto.errors %}{{ e }}<br>{% endfor %}
          </div>
        {% endif %}
      </div>


    </div>

    <div class="form-row">
      <div class="form-group col-md-3">
        <label for="{{ form.temp_scale.id_for_label }}">Escala</label>
        {{ form.temp_scale|add_class:"form-control form-control-sm" }}
        {% if form.temp_scale.errors %}
          <div class="text-danger small mt-1">
            {% for e in form.temp_scale.errors %}{{ e }}<br>{% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="form-group col-md-3">
        <label for="{{ form.temperatura_min.id_for_label }}">Temp. mínima</label>
        {{ form.temperatura_min|add_class:"form-control form-control-sm" }}
        {% if form.temperatura_min.errors %}
          <div class="text-danger small mt-1">
            {% for e in form.temperatura_min.errors %}{{ e }}<br>{% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="form-group col-md-3">
        <label for="{{ form.temperatura_max.id_for_label }}">Temp. máxima</label>
        {{ form.temperatura_max|add_class:"form-control form-control-sm" }}
        {% if form.temperatura_max.errors %}
          <div class="text-danger small mt-1">
            {% for e in form.temperatura_max.errors %}{{ e }}<br>{% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="form-group col-md-3">
        {# espacio para que se vea balanceado; si quieres aquí metemos algo más luego #}
      </div>
    </div>

    <div class="form-row">
      <div class="form-group col-md-12">
        <label for="{{ form.observations.id_for_label }}">Observaciones</label>
        {{ form.observations|add_class:"form-control form-control-sm" }}
      </div>
    </div>

  </div>

  <div class="card-footer text-right py-2">
    <button class="btn btn-primary btn-sm" type="submit">
      <i class="fas fa-save"></i>
      {% if object %}Guardar cambios{% else %}Crear viaje{% endif %}
    </button>
  </div>
</form>

<script>
(function() {
  const clientSelect = document.getElementById("{{ form.client.auto_id }}");
  const routeSelect  = document.getElementById("{{ form.route.auto_id }}");
  const routesUrl = "{% url 'trips:ajax_routes_by_client' %}";

  function setRouteOptions(items, keepValue) {
    const current = keepValue ? routeSelect.value : "";
    routeSelect.innerHTML = "";

    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Selecciona ruta…";
    routeSelect.appendChild(opt0);

    for (const it of items) {
      const opt = document.createElement("option");
      opt.value = String(it.id);
      opt.textContent = it.label;
      routeSelect.appendChild(opt);
    }

    if (keepValue && current) routeSelect.value = current;
  }

  async function loadRoutesForClient(clientId, keepValue=false) {
    if (!clientId) {
      setRouteOptions([], false);
      routeSelect.disabled = true;
      return;
    }

    routeSelect.disabled = true;

    const resp = await fetch(routesUrl + "?client_id=" + encodeURIComponent(clientId), {
      headers: {"X-Requested-With": "XMLHttpRequest"}
    });
    const data = await resp.json();

    setRouteOptions(data.results || [], keepValue);
    routeSelect.disabled = false;
  }

  clientSelect.addEventListener("change", function() {
    loadRoutesForClient(this.value, false);
  });

  const initialClient = clientSelect.value;
  if (initialClient) loadRoutesForClient(initialClient, true);
  else routeSelect.disabled = true;

  // ===== Clasificación: NACIONAL => transfer disabled + vacío =====
  const clasificacionSelect = document.getElementById("{{ form.clasificacion.auto_id }}");
  const transferSelect = document.getElementById("{{ form.transfer_operator.auto_id }}");
  const transferHidden = document.getElementById("transfer_operator_hidden");
  const formEl = document.querySelector("form");

  function applyClasificacionRules() {
    if (!clasificacionSelect || !transferSelect || !transferHidden) return;

    const isNacional = (clasificacionSelect.value === "NACIONAL");

    if (isNacional) {
      transferSelect.value = "";
      transferSelect.disabled = true;
      transferHidden.value = "";
    } else {
      transferSelect.disabled = false;
      transferHidden.value = "";
    }
  }

  if (clasificacionSelect) {
    clasificacionSelect.addEventListener("change", applyClasificacionRules);
  }
  applyClasificacionRules();

  if (formEl) {
    formEl.addEventListener("submit", function() {
      if (transferSelect && transferSelect.disabled && transferHidden) {
        transferHidden.value = "";
      }
    });
  }

  // ===== Temperatura: sugeridos según escala =====
  const scaleSelect = document.getElementById("{{ form.temp_scale.auto_id }}");
  const minInput = document.getElementById("{{ form.temperatura_min.auto_id }}");
  const maxInput = document.getElementById("{{ form.temperatura_max.auto_id }}");

  if (scaleSelect && minInput && maxInput) {
    scaleSelect.addEventListener("change", function () {
      if (this.value === "C") {
        // Celsius
        minInput.value = "10";
        maxInput.value = "12";
      } else {
        // Fahrenheit
        minInput.value = "50";
        maxInput.value = "52";
      }
    });
  }
})();
</script>

{% endblock %}
