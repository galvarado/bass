{# templates/trips/form.html #}
{% extends "base.html" %}
{% load form_extras %}
{% block title %}{% if object %}Editar Viaje{% else %}Nuevo Viaje{% endif %} · BASS{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">{% if object %}Editar Viaje{% else %}Nuevo Viaje{% endif %}</h1>
  <a href="{% url 'trips:list' %}" class="btn btn-light btn-sm">
    <i class="fas fa-arrow-left"></i> Volver
  </a>
</div>

<form method="post" class="card shadow-sm form-compact">
  {% csrf_token %}
  <div class="card-body">

    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {% for e in form.non_field_errors %}{{ e }}<br>{% endfor %}
      </div>
    {% endif %}

    <!-- ===== DATOS DEL VIAJE ===== -->
    <h6 class="text-primary mb-2">
      <i class="fas fa-route mr-1"></i> Datos del viaje
    </h6>

    <div class="form-row">
      <div class="form-group col-md-5">
        <label for="{{ form.client.id_for_label }}">Cliente</label>
        {{ form.client|add_class:"form-control form-control-sm" }}
        <small class="text-muted">Primero elige el cliente para cargar sus rutas.</small>
      </div>

      <div class="form-group col-md-7">
        <label for="{{ form.route.id_for_label }}">Ruta</label>
        {{ form.route|add_class:"form-control form-control-sm" }}
      </div>
    </div>

    <!-- ===== ASIGNACIÓN ===== -->
    <hr>
    <h6 class="text-primary mb-2">
      <i class="fas fa-truck mr-1"></i> Asignación
    </h6>
    <div class="form-row">
      <div class="form-group col-md-4">
        <label for="{{ form.operator.id_for_label }}">Operador</label>
        {{ form.operator|add_class:"form-control" }}
      </div>
      <div class="form-group col-md-4">
        <label for="{{ form.truck.id_for_label }}">Camión</label>
        {{ form.truck|add_class:"form-control" }}
      </div>
      <div class="form-group col-md-4">
        <label for="{{ form.reefer_box.id_for_label }}">Caja</label>
        {{ form.reefer_box|add_class:"form-control" }}
      </div>
    </div>

    <!-- ===== TRANSFER Y OBSERVACIONES ===== -->
    <hr>
    <h6 class="text-primary mb-2">
      <i class="fas fa-exchange-alt mr-1"></i> Detalles
    </h6>
    <div class="form-row">
      <div class="form-group col-md-3">
        <label for="{{ form.transfer_operator.id_for_label }}">Transfer</label>
        {{ form.transfer_operator|add_class:"form-control" }}
      </div>
      <div class="form-group col-md-9">
        <label for="{{ form.observations.id_for_label }}">Observaciones</label>
        {{ form.observations|add_class:"form-control" }}
      </div>
    </div>

  </div>

  <div class="card-footer text-right py-2">
    <button class="btn btn-primary btn-sm" type="submit">
      <i class="fas fa-save"></i>
      {% if object %}Guardar cambios{% else %}Crear viaje{% endif %}
    </button>
  </div>
</form>

<script>
(function() {
  const clientSelect = document.getElementById("{{ form.client.auto_id }}");
  const routeSelect  = document.getElementById("{{ form.route.auto_id }}");

  const routesUrl = "{% url 'trips:ajax_routes_by_client' %}";

  function setRouteOptions(items, keepValue) {
    const current = keepValue ? routeSelect.value : "";

    // limpia
    routeSelect.innerHTML = "";

    // opción default
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Selecciona ruta…";
    routeSelect.appendChild(opt0);

    // agrega items
    for (const it of items) {
      const opt = document.createElement("option");
      opt.value = String(it.id);
      opt.textContent = it.label;
      routeSelect.appendChild(opt);
    }

    // intenta restaurar selección
    if (keepValue && current) {
      routeSelect.value = current;
    }
  }

  async function loadRoutesForClient(clientId, keepValue=false) {
    if (!clientId) {
      setRouteOptions([], false);
      routeSelect.disabled = true;
      return;
    }

    routeSelect.disabled = true;

    const resp = await fetch(routesUrl + "?client_id=" + encodeURIComponent(clientId), {
      headers: {"X-Requested-With": "XMLHttpRequest"}
    });
    const data = await resp.json();

    setRouteOptions(data.results || [], keepValue);
    routeSelect.disabled = false;
  }

  // evento: cambio cliente => recarga rutas
  clientSelect.addEventListener("change", function() {
    loadRoutesForClient(this.value, false);
  });

  // al cargar página:
  // - si estás editando, normalmente ya hay client y route
  // - recarga rutas y conserva el valor actual
  const initialClient = clientSelect.value;
  if (initialClient) {
    loadRoutesForClient(initialClient, true);
  } else {
    routeSelect.disabled = true;
  }
})();
</script>
{% endblock %}
