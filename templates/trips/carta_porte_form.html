{# templates/trips/carta_porte_form.html #}
{% extends "base.html" %}
{% load form_extras %}

{% block title %}Carta Porte · Viaje #{{ trip.id }} · BASS{% endblock %}

{% block content %}

<style>
  /* ✅ Estado arriba a la derecha, sobre los botones */
  .cp-footer-right {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    width: 100%;
  }

  .cp-statusbar {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .cp-statusbar .badge { font-size: .78rem; }

  .loc-collapse { display: none; }
  .loc-collapse.show { display: block; }

  .loc-toggle { text-decoration: none !important; }
  .loc-chevron { transition: transform .15s ease-in-out; }
  .loc-chevron.rotate-180 { transform: rotate(180deg); }

  .goods-mercancia select { min-width: 180px; }

  .cp-compact label { margin-bottom: .15rem; }
  .cp-compact .form-group { margin-bottom: .35rem; }
  .cp-compact input.form-control-sm,
  .cp-compact select.form-control-sm {
    padding-top: .15rem;
    padding-bottom: .15rem;
    height: calc(1.2em + .5rem + 2px);
  }

  .cp-totals .input-group-text {
    min-width: 90px;
    justify-content: flex-end;
  }

  .cp-w-itrn { max-width: 170px; }
  .cp-w-ped { max-width: 170px; }
  .cp-w-ord { max-width: 160px; }

  #goods-table td { padding: .25rem .35rem; vertical-align: middle; }
  #goods-table input.form-control-sm,
  #goods-table select.form-control-sm {
    height: 26px;
    padding: .10rem .35rem;
    font-size: .82rem;
    line-height: 1.1;
  }

  .w-merc { min-width: 150px; }
  .w-clv  { width: 100px; min-width:100px; }
  .w-cant { width: 90px;  min-width:90px;  }
  .w-und  { width: 120px; min-width:120px; }
  .w-emb  { width: 90px;  min-width:90px;  }
  .w-peso { width: 90px;  min-width:90px;  }
  .w-val  { width: 110px; min-width:110px; }
  .w-mon  { width: 70px;  min-width:70px;  text-transform: uppercase; }
  .w-frac { width: 130px; min-width:130px; }
  .w-uuid { width: 180px; min-width:180px; }
  .w-ped  { width: 100px; min-width:100px; }
  .w-del { width: 48px; min-width: 48px; }

  .cp-ro {
    background: #f6f7fb;
    border: 1px solid #dfe3ee;
    border-radius: 4px;
    padding: .20rem .35rem;
    height: 26px;
    display: flex;
    align-items: center;
    font-size: .82rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .js-remove-good{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:32px;
    height:26px;
    padding:0;
  }

  .goods-scroll-ctrl{
    overflow-x:auto;
    overflow-y:hidden;
    height:14px;
    border:1px solid #e6e8ef;
    border-radius:6px;
    background:#fff;
  }
  .goods-scroll-ctrl-inner{ height:1px; }

  #goods-scroll-wrap { scrollbar-width: none; }
  #goods-scroll-wrap::-webkit-scrollbar { height: 0; }

  /* ✅ barra de controles del concepto */
  .cpitem-taxbar { display:flex; gap:14px; align-items:center; flex-wrap: wrap; }
  .cpitem-taxbar .custom-control { margin-bottom: 0; }

  .form-control[readonly] { background: #f6f7fb; }

  /* ✅ UX: bloque compacto de acciones */
  .cp-actions { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
  .cp-actions .cp-actions-right { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .cp-hint { font-size:.82rem; color:#6c757d; }

  .cp-footer{
    background:#f8f9fc;            /* estilo SB Admin */
    border-top:1px solid #e3e6f0;
    gap:12px;
  }

  .cp-statusbar{ gap:8px; }

  .cp-badge{
    font-size:.80rem;
    letter-spacing:.3px;
    padding:.38rem .6rem;
    display:inline-flex;
    align-items:center;
    gap:.35rem;
  }

  .cp-dot{
    width:8px; height:8px;
    border-radius:999px;
    display:inline-block;
    box-shadow:0 0 0 2px rgba(255,255,255,.6);
  }

  .cp-dot-secondary{ background:#858796; }
  .cp-dot-info{      background:#36b9cc; }
  .cp-dot-success{   background:#1cc88a; }
  .cp-dot-danger{    background:#e74a3b; }
  .cp-dot-dark{      background:#5a5c69; }
  .cp-dot-light{     background:#d1d3e2; }

  .cp-meta{
    font-size:.80rem;
    color:#6c757d;
    background:#fff;
    border:1px solid #e3e6f0;
    border-radius:999px;
    padding:.25rem .55rem;
    display:inline-flex;
    align-items:center;
    gap:.35rem;
  }

  .cp-meta-warn{
    color:#856404;
    background:#fff3cd;
    border-color:#ffeeba;
  }

  .cp-mono{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size:.78rem;
  }

  .cp-locked {
    background-color: #f6f7fb !important;
    border-color: #d1d3e2 !important;
    color: #6c757d;
    cursor: not-allowed;
  }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Carta Porte · Viaje #{{ trip.id }}</h1>

  <a href="{% url 'trips:detail' pk=trip.pk %}" class="btn btn-light btn-sm">
    <i class="fas fa-arrow-left"></i> Volver
  </a>
</div>

<form id="cp-form" method="post" class="card shadow-sm">
  {% csrf_token %}

  <div class="card-body">

    {% if messages %}
      {% for m in messages %}
        <div class="alert alert-{{ m.tags }}">{{ m }}</div>
      {% endfor %}
    {% endif %}

    {# ✅ Errores SIEMPRE visibles y completos #}
    {% if form.errors or form.non_field_errors or fs_locations.errors or fs_goods.errors or fs_items.errors or fs_locations.non_form_errors or fs_goods.non_form_errors or fs_items.non_form_errors %}
      <div class="alert alert-danger">
        <div class="font-weight-bold mb-2">Errores detectados (detalle)</div>

        {% if form.non_field_errors %}
          <div class="mb-2"><strong>Formulario:</strong> {{ form.non_field_errors }}</div>
        {% endif %}

        {% for field in form %}
          {% if field.errors %}
            <div class="mb-1">
              <strong>{{ field.label }}:</strong> {{ field.errors }}
            </div>
          {% endif %}
        {% endfor %}

        {% if fs_locations.non_form_errors %}
          <div class="mt-2"><strong>Ubicaciones (general):</strong> {{ fs_locations.non_form_errors }}</div>
        {% endif %}
        {% if fs_goods.non_form_errors %}
          <div class="mt-2"><strong>Mercancías (general):</strong> {{ fs_goods.non_form_errors }}</div>
        {% endif %}
        {% if fs_items.non_form_errors %}
          <div class="mt-2"><strong>Concepto (general):</strong> {{ fs_items.non_form_errors }}</div>
        {% endif %}

        {% for f in fs_locations.forms %}
          {% if f.errors %}
            <div class="mt-2">
              <strong>Ubicación #{{ forloop.counter }}:</strong>
              {{ f.errors }}
            </div>
          {% endif %}
        {% endfor %}

        {% for f in fs_goods.forms %}
          {% if f.errors %}
            <div class="mt-2">
              <strong>Mercancía #{{ forloop.counter }}:</strong>
              {{ f.errors }}
            </div>
          {% endif %}
        {% endfor %}

        {% for f in fs_items.forms %}
          {% if f.errors %}
            <div class="mt-2">
              <strong>Concepto #{{ forloop.counter }}:</strong>
              {{ f.errors }}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}

    <h6 class="text-primary mb-2">
      <i class="fas fa-file-invoice mr-1"></i> Datos generales
    </h6>

    <div class="row cp-compact">
      <div class="col-md-12">

        <div class="form-row">
          <div class="form-group col-md-4">
            <label>Cliente (Paga)</label>
            {{ form.customer|add_class:"form-control form-control-sm" }}
          </div>

          <div class="form-group col-md-2">
            <label>Fecha salida</label>
            {{ form.fecha_salida|add_class:"form-control form-control-sm" }}
          </div>

          <div class="form-group col-md-2">
            <label>Fecha llegada</label>
            {{ form.fecha_llegada|add_class:"form-control form-control-sm" }}
          </div>

          <div class="form-group col-md-2">
            <label>US entry</label>
            {{ form.us_entry|add_class:"form-control form-control-sm" }}
          </div>

          <div class="form-group col-md-2">
            <label>ITRN</label>
            {{ form.itrn|add_class:"form-control form-control-sm" }}
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-md-3">
            <label>Pedimento</label>
            {{ form.pedimento|add_class:"form-control form-control-sm" }}
          </div>

          <div class="form-group col-md-3">
            <label>Orden</label>
            {{ form.orden|add_class:"form-control form-control-sm" }}
          </div>

          <div class="form-group col-md-3">
            <label>Factura cliente</label>
            {{ form.factura_clinte|add_class:"form-control form-control-sm" }}
          </div>
        </div>

      </div>
    </div>

    <hr>
    <h6 class="text-primary mb-2">
      <i class="fas fa-route mr-1"></i> Datos del viaje
    </h6>

    <div class="form-row">
      <div class="form-group col-md-3">
        <label>Ruta</label>
        <input class="form-control form-control-sm" value="{{ trip.route }}" readonly>
      </div>
      <div class="form-group col-md-3">
        <label>Operador</label>
        <input class="form-control form-control-sm" value="{{ trip.operator }}" readonly>
      </div>
      <div class="form-group col-md-3">
        <label>Unidad - Caja</label>
        <input class="form-control form-control-sm" value="{{ trip.truck }} - {{ trip.reefer_box }}" readonly>
      </div>
    </div>

    <hr>
    <h6 class="text-primary mb-2">
      <i class="fas fa-map-marker-alt mr-1"></i> Origen / Destino
    </h6>

    {{ fs_locations.management_form }}

    <div id="loc-forms">
      {% for f in fs_locations.forms %}
        <div class="border rounded mb-2 loc-form">

          {# ✅ CRÍTICO: hidden fields completos (id, carta_porte, etc.) #}
          {% for h in f.hidden_fields %}{{ h }}{% endfor %}

          <div class="d-none">
            {{ f.tipo_ubicacion }}
            {{ f.orden }}
          </div>

          <button type="button"
                  class="btn btn-link btn-block text-left py-2 px-2 d-flex justify-content-between align-items-center loc-toggle"
                  data-target="#loc-{{ forloop.counter0 }}"
                  aria-controls="loc-{{ forloop.counter0 }}"
                  aria-expanded="false">

            <div class="d-flex align-items-center">
              {% if f.instance.tipo_ubicacion == "Origen" %}
                <span class="badge badge-success mr-2">Origen</span>
              {% else %}
                <span class="badge badge-primary mr-2">Destino</span>
              {% endif %}

              <span class="text-dark font-weight-bold">
                {{ f.nombre.value|default:f.instance.nombre|default:"(sin nombre)" }}
              </span>

              {% if f.localidad.value or f.instance.localidad %}
                <span class="text-muted ml-2 small">
                  · {{ f.localidad.value|default:f.instance.localidad }}
                </span>
              {% endif %}
            </div>

            <i class="fas fa-chevron-down text-muted loc-chevron"></i>
          </button>

          <div id="loc-{{ forloop.counter0 }}" class="loc-collapse px-2 pb-2">

            <div class="form-row mt-2">
              <div class="form-group col-md-4">
                <label>Cliente</label>
                {% if f.instance.tipo_ubicacion == "Origen" %}
                  <input class="form-control form-control-sm" value="{{ trip.route.origen.client.nombre }}" readonly>
                {% else %}
                  <input class="form-control form-control-sm" value="{{ trip.route.destino.client.nombre }}" readonly>
                {% endif %}
              </div>

              <div class="form-group col-md-4">
                <label>Ubicación</label>
                {{ f.nombre|add_class:"form-control form-control-sm loc-ro" }}
              </div>

              <div class="form-group col-md-4">
                <label>Población</label>
                {{ f.localidad|add_class:"form-control form-control-sm loc-ro" }}
              </div>
            </div>

            <div class="form-row">
              <div class="form-group col-md-4">
                <label>Calle</label>
                {{ f.calle|add_class:"form-control form-control-sm loc-ro" }}
              </div>

              <div class="form-group col-md-4">
                <label>No. exterior</label>
                {{ f.numero_exterior|add_class:"form-control form-control-sm loc-ro" }}
              </div>
            </div>

            <div class="form-row">
              <div class="form-group col-md-4">
                <label>Colonia</label>
                {{ f.colonia|add_class:"form-control form-control-sm loc-ro" }}
              </div>

              <div class="form-group col-md-4">
                <label>Municipio</label>
                {{ f.municipio|add_class:"form-control form-control-sm loc-ro" }}
              </div>

              <div class="form-group col-md-4">
                <label>Estado</label>
                {{ f.estado|add_class:"form-control form-control-sm loc-ro" }}
              </div>
            </div>

            <div class="form-row">
              <div class="form-group col-md-4">
                <label>País</label>
                {{ f.pais|add_class:"form-control form-control-sm loc-ro" }}
              </div>

              <div class="form-group col-md-4">
                <label>CP</label>
                {{ f.codigo_postal|add_class:"form-control form-control-sm loc-ro" }}
              </div>
            </div>

          </div>
        </div>
      {% endfor %}
    </div>

    <hr>

    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="text-primary mb-0">
        <i class="fas fa-boxes mr-1"></i> Mercancías
      </h6>
      <button type="button" class="btn btn-outline-primary btn-sm" id="btn-add-good">
        <i class="fas fa-plus"></i> Agregar mercancía
      </button>
    </div>

    {{ fs_goods.management_form }}

    <div class="table-responsive" id="goods-scroll-wrap">
      <table class="table table-sm table-bordered mb-0" id="goods-table">
        <thead class="thead-light">
          <tr>
            <th class="w-merc">Mercancía</th>
            <th class="w-clv">Clave</th>
            <th class="w-frac">Fracción arancelaria</th>
            <th class="w-uuid">UUID comercio exterior</th>
            <th class="w-cant">Cantidad</th>
            <th class="w-und">Unidad</th>
            <th class="w-peso">Peso</th>
            <th class="w-val">Valor</th>
            <th class="w-mon">Moneda</th>
            <th class="w-emb">Embalaje</th>
            <th class="w-ped">Pedimento</th>
            <th class="w-del text-center">✕</th>
          </tr>
        </thead>

        <tbody id="goods-rows">
          {% for f in fs_goods.forms %}
          <tr class="goods-row">
            <td class="w-merc goods-mercancia">
              {# ✅ CRÍTICO: hidden fields completos (id, carta_porte, etc.) #}
              {% for h in f.hidden_fields %}{{ h }}{% endfor %}
              {{ f.mercancia|add_class:"form-control form-control-sm js-mercancia" }}
            </td>

            <td class="w-clv"><div class="cp-ro js-clave"></div></td>
            <td class="w-frac"><div class="cp-ro js-fraccion"></div></td>

            {# ✅ AHORA ES INPUT EDITABLE #}
            <td class="w-uuid">
              {{ f.comercio_exterior_uuid|add_class:"form-control form-control-sm js-uuidce-input" }}
            </td>

            <td class="w-cant">{{ f.cantidad|add_class:"form-control form-control-sm" }}</td>
            <td class="w-und">{{ f.unidad|add_class:"form-control form-control-sm" }}</td>
            <td class="w-peso">{{ f.peso_en_kg|add_class:"form-control form-control-sm" }}</td>
            <td class="w-val">{{ f.valor_mercancia|add_class:"form-control form-control-sm" }}</td>
            <td class="w-mon">{{ f.moneda|add_class:"form-control form-control-sm js-moneda" }}</td>
            <td class="w-emb">{{ f.embalaje|add_class:"form-control form-control-sm" }}</td>
            <td class="w-ped">{{ f.pedimento|add_class:"form-control form-control-sm" }}</td>

            <td class="w-del text-center align-middle">
              <div class="d-none">
                {{ f.DELETE }}
              </div>
              <button type="button"
                      class="btn btn-sm btn-outline-danger js-remove-good"
                      title="Quitar mercancía">
                <i class="fas fa-trash-alt"></i>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="d-none">
</div>
    <template id="goods-empty-row">
      <tr class="goods-row">
        <td class="w-merc goods-mercancia">__HIDDEN____MERCANCIA__</td>
        <td class="w-clv"><div class="cp-ro js-clave"></div></td>
        <td class="w-frac"><div class="cp-ro js-fraccion"></div></td>
        <td class="w-uuid">__UUIDCE__</td>

        <td class="w-cant">__CANT__</td>
        <td class="w-und">__UNIDAD__</td>
        <td class="w-peso">__PESO__</td>
        <td class="w-val">__VALOR__</td>
        <td class="w-mon">__MONEDA__</td>
        <td class="w-emb">__EMB__</td>

        <td class="w-ped">__PEDIMENTO__</td>
        <td class="w-del text-center align-middle">
          <div class="d-none">__DELETE__</div>
          <button type="button"
                  class="btn btn-sm btn-outline-danger js-remove-good"
                  title="Quitar mercancía">
            <i class="fas fa-trash-alt"></i>
          </button>
        </td>
      </tr>
    </template>

    <div class="goods-scroll-ctrl my-2" id="goods-scroll-ctrl" aria-label="Scroll horizontal mercancías">
      <div class="goods-scroll-ctrl-inner"></div>
    </div>

    <hr>
    <h6 class="text-primary mb-2">
      <i class="fas fa-file-invoice mr-1"></i> Complemento Carta de Porte
    </h6>

    <div class="row cp-compact">
      <div class="col-md-12">
        <div class="form-row">
          <div class="form-group col-md-3">
            <label>Método de pago</label>
            {{ form.payment_method|add_class:"form-control form-control-sm" }}
          </div>
          <div class="form-group col-md-3">
            <label>Forma de pago</label>
            {{ form.payment_form|add_class:"form-control form-control-sm" }}
          </div>
          <div class="form-group col-md-2">
            <label>Moneda</label>
            {{ form.currency|add_class:"form-control form-control-sm" }}
          </div>
          <div class="form-group col-md-2">
            <label>Tipo</label>
            {{ form.type|add_class:"form-control form-control-sm" }}
          </div>
          <div class="form-group col-md-2">
            <label>Uso CFDI</label>
            {{ form.uso_cfdi|add_class:"form-control form-control-sm" }}
          </div>
          <div class="form-group col-md-4">
            <label>Observaciones</label>
            {{ form.observations|add_class:"form-control form-control-sm" }}
          </div>
        </div>
      </div>
    </div>

    <hr class="my-2">

    {# ========================================= #}
    {# ✅ CONCEPTO + checkboxes (default OFF)      #}
    {# ========================================= #}
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="text-primary mb-0">
        <i class="fas fa-list mr-1"></i> Concepto
      </h6>

      <div class="cpitem-taxbar">
        <div class="custom-control custom-checkbox">
          <input type="checkbox" class="custom-control-input" id="chk-item-iva16">
          <label class="custom-control-label small" for="chk-item-iva16">Aplicar 16% IVA</label>
        </div>

        <div class="custom-control custom-checkbox">
          <input type="checkbox" class="custom-control-input" id="chk-item-retiva">
          <label class="custom-control-label small" for="chk-item-retiva">Aplicar retención IVA (4%)</label>
        </div>

        <div class="custom-control custom-checkbox">
          <input type="checkbox" class="custom-control-input" id="chk-item-desc">
          <label class="custom-control-label small" for="chk-item-desc">Aplicar descuento</label>
        </div>
      </div>
    </div>

    {{ fs_items.management_form }}

    <div class="table-responsive" id="cpitems-scroll-wrap">
      <table class="table table-sm table-bordered mb-0" id="cpitems-table">
        <thead class="thead-light">
          <tr>
            <th style="min-width:90px;">Cantidad</th>
            <th style="min-width:130px;">Unidad</th>
            <th style="min-width:160px;">Producto</th>
            <th style="min-width:220px;">Descripción</th>
            <th style="min-width:110px;">Precio</th>
            <th style="min-width:110px;">Descuento</th>
            <th style="min-width:120px;">Subtotal</th>
            <th style="min-width:90px;">IVA %</th>
            <th style="min-width:120px;">IVA monto</th>
            <th style="min-width:90px;">Ret IVA %</th>
            <th style="min-width:150px;">Ret IVA monto</th>
            <th style="min-width:120px;">Importe</th>
          </tr>
        </thead>

        <tbody id="cpitems-rows">
          {% for f in fs_items.forms %}
          <tr class="cpitem-row">

            {# ✅ CRÍTICO: hidden fields completos (id, carta_porte, etc.) #}
            {% for h in f.hidden_fields %}{{ h }}{% endfor %}

            <td>{{ f.cantidad }}</td>
            <td>{{ f.unidad }}</td>
            <td>{{ f.producto }}</td>
            <td>{{ f.descripcion }}</td>
            <td>{{ f.precio }}</td>
            <td>{{ f.descuento }}</td>

            <td><input class="form-control form-control-sm text-right js-item-subtotal-ui" value="{{ f.instance.subtotal|default_if_none:'0.00' }}" readonly></td>
            <td>{{ f.iva_pct }}</td>
            <td><input class="form-control form-control-sm text-right js-item-iva-ui" value="{{ f.instance.iva_monto|default_if_none:'0.00' }}" readonly></td>
            <td>{{ f.ret_iva_pct }}</td>
            <td><input class="form-control form-control-sm text-right js-item-ret-ui" value="{{ f.instance.ret_iva_monto|default_if_none:'0.00' }}" readonly></td>
            <td><input class="form-control form-control-sm text-right js-item-imp-ui" value="{{ f.instance.importe|default_if_none:'0.00' }}" readonly></td>

          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <hr>

    <div class="row">
      <div class="col-md-9"></div>
      <div class="col-md-3 cp-totals">
        <div class="form-group mb-0">
          <label class="mb-1">Totales</label>

          <div class="input-group input-group-sm mb-1">
            <div class="input-group-prepend">
              <span class="input-group-text">Subtotal $</span>
            </div>

            <input type="text"
                   class="form-control form-control-sm js-subtotal-ui text-right"
                   value="{{ form.subtotal.value|default_if_none:'0.00' }}"
                   readonly>

            <input type="hidden" name="subtotal" class="js-subtotal"
                   value="{{ form.subtotal.value|default_if_none:'0.00' }}">
          </div>

          <div class="input-group input-group-sm mb-1">
            <div class="input-group-prepend">
              <span class="input-group-text">IVA $</span>
            </div>

            <input type="text"
                   class="form-control form-control-sm js-iva-ui text-right"
                   value="{{ form.iva.value|default_if_none:'0.00' }}"
                   readonly>

            <input type="hidden" name="iva" class="js-iva"
                   value="{{ form.iva.value|default_if_none:'0.00' }}">
          </div>

          <div class="input-group input-group-sm mb-1">
            <div class="input-group-prepend">
              <span class="input-group-text">Ret $</span>
            </div>

            <input type="text"
                   class="form-control form-control-sm js-retencion-ui text-right"
                   value="{{ form.retencion.value|default_if_none:'0.00' }}"
                   readonly>

            <input type="hidden" name="retencion" class="js-retencion"
                   value="{{ form.retencion.value|default_if_none:'0.00' }}">
          </div>

          <div class="input-group input-group-sm">
            <div class="input-group-prepend">
              <span class="input-group-text">Total $</span>
            </div>

            <input type="text"
                   class="form-control form-control-sm js-total-ui text-right"
                   value="{{ form.total.value|default_if_none:'0.00' }}"
                   readonly>

            <input type="hidden" name="total" class="js-total"
                   value="{{ form.total.value|default_if_none:'0.00' }}">
          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="card-footer cp-footer d-flex justify-content-between align-items-center flex-wrap py-2">

    {# ✅ Estado (izquierda) #}
    <div class="cp-statusbar d-flex align-items-center flex-wrap">
      <span class="text-muted small mr-2">Estado</span>

      {% if carta.status == "draft" %}
        <span class="badge badge-pill badge-secondary cp-badge">
          <span class="cp-dot cp-dot-secondary"></span> Borrador
        </span>
      {% elif carta.status == "ready" %}
        <span class="badge badge-pill badge-info cp-badge">
          <span class="cp-dot cp-dot-info"></span> Lista para timbrar
        </span>
      {% elif carta.status == "stamped" %}
        <span class="badge badge-pill badge-success cp-badge">
          <span class="cp-dot cp-dot-success"></span> Timbrada
        </span>
      {% elif carta.status == "canceled" %}
        <span class="badge badge-pill badge-dark cp-badge">
          <span class="cp-dot cp-dot-dark"></span> Cancelada
        </span>
      {% elif carta.status == "error" %}
        <span class="badge badge-pill badge-danger cp-badge">
          <span class="cp-dot cp-dot-danger"></span> Error
        </span>
      {% else %}
        <span class="badge badge-pill badge-light cp-badge">
          <span class="cp-dot cp-dot-light"></span> {{ carta.status|default:"(sin status)" }}
        </span>
      {% endif %}

      {% if carta.uuid %}
        <span class="cp-meta ml-2" title="Folio fiscal (UUID) del CFDI timbrado">
          Folio fiscal: <span class="cp-mono">{{ carta.uuid }}</span>
        </span>
      {% endif %}

      {% if carta.last_error %}
        <span class="cp-meta cp-meta-warn ml-2" title="{{ carta.last_error }}">
          <i class="fas fa-exclamation-triangle mr-1"></i>
          {{ carta.last_error|truncatechars:80 }}
        </span>
      {% endif %}
    </div>

    {# ✅ Acciones (derecha) #}
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-primary btn-sm" type="submit" name="action" value="save">
        <i class="fas fa-save"></i> Guardar
      </button>
      &nbsp;

      {# ✅ Blindaje UI: si ya está timbrada o tiene UUID => no permitir re-timbrar #}
      {% if carta.status == "stamped" or carta.uuid %}
        <button class="btn btn-success btn-sm" type="button" disabled
                title="Este CFDI ya fue timbrado y no puede generarse de nuevo.">
          <i class="fas fa-file-invoice"></i> Timbrar CFDI
        </button>

      {% elif carta.status == "canceled" %}
        <button class="btn btn-dark btn-sm" type="button" disabled
                title="Este CFDI está cancelado y no puede timbrarse nuevamente desde aquí.">
          <i class="fas fa-ban"></i> CFDI cancelado
        </button>

      {% else %}
        {% if can_generate_cfdi %}
          <button class="btn btn-success btn-sm" type="submit" name="action" value="generate_cfdi">
            <i class="fas fa-file-invoice"></i> Timbrar CFDI
          </button>
        {% else %}
          <button class="btn btn-success btn-sm" type="button" disabled title="Guarda primero para habilitar">
            <i class="fas fa-file-invoice"></i> Timbrar CFDI
          </button>
        {% endif %}
      {% endif %}
    </div>

</form>

<script>
  window.CP_IS_STAMPED = {% if carta.status == "stamped" %}true{% else %}false{% endif %};
</script>
<script>
(function () {
  function ready(fn){
    if (document.readyState !== "loading") fn();
    else document.addEventListener("DOMContentLoaded", fn);
  }

  ready(function () {
    const isStamped = !!window.CP_IS_STAMPED;
    const form = document.getElementById("cp-form");

    // ==========================
    // ✅ Direcciones SIEMPRE bloqueadas (origen/destino)
    // ==========================
    document.querySelectorAll(".loc-ro").forEach(el => {
      if (el.tagName === "SELECT") {
        el.disabled = true;
        el.tabIndex = -1;
      } else {
        el.readOnly = true;
        el.tabIndex = -1;
      }
      el.classList.add("cp-locked");
    });

    // ==========================
    // Accordion Origen/Destino (solo si NO timbrada)
    // ==========================
    function togglePanel(btn) {
      let targetSel = (btn.getAttribute("data-target") || "").trim();
      if (!targetSel) return;
      if (!targetSel.startsWith("#")) targetSel = "#" + targetSel;

      const panel = document.querySelector(targetSel);
      if (!panel) return;

      const open = !panel.classList.contains("show");
      panel.classList.toggle("show", open);

      const chevron = btn.querySelector(".loc-chevron");
      if (chevron) chevron.classList.toggle("rotate-180", open);

      btn.setAttribute("aria-expanded", open ? "true" : "false");
    }

    document.querySelectorAll(".loc-toggle").forEach(btn => {
      if (isStamped) return;
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        e.stopPropagation();
        togglePanel(btn);
      });
    });

    // ==========================
    // Utils dinero
    // ==========================
    function parseMoney(raw) {
      if (raw === null || raw === undefined) return 0;
      let s = String(raw).trim();
      if (!s) return 0;

      s = s.replace(/\u00A0/g, " ").replace(/\s/g, "").replace(/\$/g, "");
      s = s.replace(/[^\d.,-]/g, "");

      const lastComma = s.lastIndexOf(",");
      const lastDot = s.lastIndexOf(".");

      if (lastComma !== -1 && lastDot !== -1) {
        const decSep = lastComma > lastDot ? "," : ".";
        const thouSep = decSep === "," ? "." : ",";
        s = s.split(thouSep).join("");
        if (decSep === ",") s = s.replace(",", ".");
      } else if (lastComma !== -1 && lastDot === -1) {
        const parts = s.split(",");
        if (parts.length === 2 && parts[1].length <= 2) s = parts[0] + "." + parts[1];
        else s = s.replace(/,/g, "");
      } else {
        s = s.replace(/,/g, "");
      }

      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }

    function round2(n) { return Math.round((n + Number.EPSILON) * 100) / 100; }

    const uiFmt = new Intl.NumberFormat("en-US", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });

    function setHidden(hiddenEl, n) { if (hiddenEl) hiddenEl.value = round2(n).toFixed(2); }
    function setUI(uiEl, n) { if (uiEl) uiEl.value = uiFmt.format(round2(n)); }

    // ==========================
    // Totales UI + Hidden
    // ==========================
    const elSubtotalUI = document.querySelector(".js-subtotal-ui");
    const elIvaUI      = document.querySelector(".js-iva-ui");
    const elRetUI      = document.querySelector(".js-retencion-ui");
    const elTotalUI    = document.querySelector(".js-total-ui");

    const elSubtotal = document.querySelector(".js-subtotal");
    const elIVA      = document.querySelector(".js-iva");
    const elRet      = document.querySelector(".js-retencion");
    const elTotal    = document.querySelector(".js-total");

    function recomputeTotalFromHidden() {
      const subtotal = parseMoney(elSubtotal?.value || "0");
      const iva      = parseMoney(elIVA?.value || "0");
      const ret      = parseMoney(elRet?.value || "0");
      const total = subtotal + iva - ret;

      setHidden(elTotal, total);
      setUI(elTotalUI, total);

      setUI(elSubtotalUI, subtotal);
      setUI(elIvaUI, iva);
      setUI(elRetUI, ret);
    }

    // ==========================
    // ✅ CONCEPTO (1 fila): helpers
    // ==========================
    function firstRow() {
      return document.querySelector("#cpitems-rows .cpitem-row");
    }
    function getFieldBySuffix(suffix) {
      const tr = firstRow();
      if (!tr) return null;
      return tr.querySelector(`[name$="-${suffix}"]`) || null;
    }
    function getROInputAtTdIndex(idx) {
      const tr = firstRow();
      if (!tr) return null;
      const tds = tr.querySelectorAll("td");
      if (!tds || !tds[idx]) return null;
      return tds[idx].querySelector("input") || null;
    }

    const $qty   = () => getFieldBySuffix("cantidad");
    const $price = () => getFieldBySuffix("precio");
    const $disc  = () => getFieldBySuffix("descuento");
    const $ivaP  = () => getFieldBySuffix("iva_pct");
    const $retP  = () => getFieldBySuffix("ret_iva_pct");

    // indices:
    // 0 cant, 1 unidad, 2 producto, 3 desc, 4 precio, 5 descuento,
    // 6 subtotal UI, 7 iva%, 8 iva monto UI, 9 ret%, 10 ret monto UI, 11 importe UI
    const $subUI = () => getROInputAtTdIndex(6);
    const $ivaMontoUI = () => getROInputAtTdIndex(8);
    const $retMontoUI = () => getROInputAtTdIndex(10);
    const $impUI = () => getROInputAtTdIndex(11);

    function setVal(el, v){ if (el) el.value = v; }
    function num(el){ return el ? parseMoney(el.value) : 0; }
    function clamp0(n){ return n < 0 ? 0 : n; }

    const chkIVA16 = document.getElementById("chk-item-iva16");
    const chkRET4  = document.getElementById("chk-item-retiva");
    const chkDESC  = document.getElementById("chk-item-desc");

    // ✅ defaults OFF siempre que NO timbrada
    if (!isStamped) {
      if (chkIVA16) chkIVA16.checked = false;
      if (chkRET4)  chkRET4.checked  = false;
      if (chkDESC)  chkDESC.checked  = false;
    }

    function applyLocks() {
      // precio siempre readonly
      const p = $price();
      if (p) { p.readOnly = true; p.tabIndex = -1; }

      // iva% siempre readonly (lo controla el checkbox)
      const ivaPct = $ivaP();
      if (ivaPct) { ivaPct.readOnly = true; ivaPct.tabIndex = -1; }

      // ret% solo editable si checkbox ON (y NO timbrada)
      const retPct = $retP();
      if (retPct) {
        const on = (!isStamped) && !!(chkRET4 && chkRET4.checked);
        retPct.readOnly = !on;
        retPct.tabIndex = on ? 0 : -1;
      }

      // descuento solo editable si checkbox ON (y NO timbrada)
      const d = $disc();
      if (d) {
        const on = (!isStamped) && !!(chkDESC && chkDESC.checked);
        d.readOnly = !on;
        d.tabIndex = on ? 0 : -1;
      }

      // si está timbrada: bloquear checkboxes
      if (isStamped) {
        [chkIVA16, chkRET4, chkDESC].forEach(c => { if (c) c.disabled = true; });
      }
    }

    function recomputeConceptAndTotals() {
      const qty   = num($qty());
      const price = num($price());
      const disc  = clamp0(num($disc()));

      const base = round2(qty * price);
      const sub  = round2(clamp0(base - disc));

      const ivaPct = (chkIVA16 && chkIVA16.checked) ? 16.0 : 0.0;
      if ($ivaP()) setVal($ivaP(), ivaPct.toFixed(2));

      // retención default 4% cuando ON
      let retPct = 0.0;
      if (chkRET4 && chkRET4.checked) {
        retPct = num($retP());
        if (!retPct) retPct = 4.0;
        if ($retP()) setVal($retP(), retPct.toFixed(2));
      } else {
        if ($retP()) setVal($retP(), "0.00");
      }

      // si descuento OFF -> forzar 0
      if (!(chkDESC && chkDESC.checked)) {
        if ($disc()) setVal($disc(), "0.00");
      }

      const ivaMonto = round2(sub * (ivaPct / 100));
      const retMonto = round2(sub * (retPct / 100));
      const importe  = round2(sub + ivaMonto - retMonto);

      // pintar UI readonly por fila
      if ($subUI())      setUI($subUI(), sub);
      if ($ivaMontoUI()) setUI($ivaMontoUI(), ivaMonto);
      if ($retMontoUI()) setUI($retMontoUI(), retMonto);
      if ($impUI())      setUI($impUI(), importe);

      // ✅ hidden del formulario principal
      setHidden(elSubtotal, sub);
      setHidden(elIVA, ivaMonto);
      setHidden(elRet, retMonto);
      recomputeTotalFromHidden();
    }

    // init: locks + cálculo inicial
    applyLocks();
    recomputeConceptAndTotals();

    // Checkboxes -> recalcular
    if (!isStamped) {
      chkIVA16?.addEventListener("change", function () {
        applyLocks();
        recomputeConceptAndTotals();
      });

      chkRET4?.addEventListener("change", function () {
        if (chkRET4.checked) {
          if ($retP()) setVal($retP(), "4.00");
        } else {
          if ($retP()) setVal($retP(), "0.00");
        }
        applyLocks();
        recomputeConceptAndTotals();
      });

      chkDESC?.addEventListener("change", function () {
        if (!chkDESC.checked) {
          if ($disc()) setVal($disc(), "0.00");
        }
        applyLocks();
        recomputeConceptAndTotals();
      });
    }

    // cambios en inputs concepto
    function bindRecalc(el) {
      if (!el) return;
      el.addEventListener("input", () => recomputeConceptAndTotals());
      el.addEventListener("blur",  () => recomputeConceptAndTotals());
    }
    bindRecalc($qty());
    bindRecalc($disc());
    bindRecalc($retP());

    // ==========================
    // Mercancías: autofill + remove + UUID editable
    // ==========================
    const cartaCurrency = "{{ form.currency.value|default_if_none:'' }}";

    function fillDiv(divEl, value) {
      if (!divEl) return;
      divEl.textContent = (value || "").trim();
      divEl.title = divEl.textContent || "";
    }

    function bindMercanciaAutofill(scopeEl) {
  const root = scopeEl || document;

  root.querySelectorAll("select.js-mercancia").forEach(sel => {
    if (sel.dataset.autofillBound === "1") return;
    sel.dataset.autofillBound = "1";

    sel.addEventListener("change", function () {
      const opt = sel.options[sel.selectedIndex];
      if (!opt) return;

      const tr = sel.closest("tr");
      if (!tr) return;

      const vClave = opt.getAttribute("data-clave") || "";
      const vFrac  = opt.getAttribute("data-fraccion") || "";
      const vUUID  = opt.getAttribute("data-uuidce") || "";

      // Clave y fracción (divs readonly)
      const claveDiv = tr.querySelector(".js-clave");
      const fracDiv  = tr.querySelector(".js-fraccion");

      if (claveDiv) claveDiv.textContent = vClave;
      if (fracDiv)  fracDiv.textContent  = vFrac;

      // ✅ UUID comercio exterior (input editable)
      const uuidInput =
        tr.querySelector('input[name$="-comercio_exterior_uuid"]') ||
        tr.querySelector("input.js-uuidce-input");

      if (uuidInput && !uuidInput.value.trim()) {
        uuidInput.value = vUUID;
      }

      // Moneda default
      const elMoneda = tr.querySelector("select.js-moneda");
      if (elMoneda && !String(elMoneda.value || "").trim() && cartaCurrency) {
        elMoneda.value = cartaCurrency;
      }
    });

    if (sel.value) {
      sel.dispatchEvent(new Event("change", { bubbles: true }));
    }
  });
}


    // Scroll sync mercancías
    const goodsWrap = document.getElementById("goods-scroll-wrap");
    const goodsCtrl = document.getElementById("goods-scroll-ctrl");
    const goodsCtrlInner = goodsCtrl?.querySelector(".goods-scroll-ctrl-inner");
    const goodsTable = document.getElementById("goods-table");

    function syncGoodsCtrlWidth() {
      if (!goodsCtrlInner || !goodsTable) return;
      goodsCtrlInner.style.width = goodsTable.scrollWidth + "px";
    }

    let syncingScroll = false;
    if (goodsWrap && goodsCtrl) {
      goodsCtrl.addEventListener("scroll", () => {
        if (syncingScroll) return;
        syncingScroll = true;
        goodsWrap.scrollLeft = goodsCtrl.scrollLeft;
        syncingScroll = false;
      });

      goodsWrap.addEventListener("scroll", () => {
        if (syncingScroll) return;
        syncingScroll = true;
        goodsCtrl.scrollLeft = goodsWrap.scrollLeft;
        syncingScroll = false;
      });
    }
    syncGoodsCtrlWidth();
    window.addEventListener("resize", syncGoodsCtrlWidth);

    function markDeletedRow(tr) {
      const del = tr.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (del) {
        del.checked = true;
        tr.style.display = "none";
      } else {
        tr.remove();
      }
      syncGoodsCtrlWidth();
    }

    function bindRemoveButtons(scopeEl) {
      const root = scopeEl || document;
      root.querySelectorAll(".js-remove-good").forEach(btn => {
        if (btn.dataset.removeBound === "1") return;
        btn.dataset.removeBound = "1";

        btn.addEventListener("click", function () {
          if (isStamped) return;
          const tr = btn.closest("tr");
          if (!tr) return;
          markDeletedRow(tr);
        });
      });
    }

    bindMercanciaAutofill(document);
    bindRemoveButtons(document);

    // ==========================
    // ✅ Agregar mercancía (prefix goods) solo si NO timbrada
    // ==========================
    const btnAddGood = document.getElementById("btn-add-good");
    const goodsBody = document.getElementById("goods-rows");
    const goodsTpl = document.getElementById("goods-empty-row");

    function bumpTotal(prefix) {
      const totalInput = document.querySelector(`input[name="${prefix}-TOTAL_FORMS"]`);
      if (!totalInput) return 0;
      const current = parseInt(totalInput.value || "0", 10);
      totalInput.value = String(current + 1);
      return current;
    }

    if (btnAddGood && goodsBody && goodsTpl && !isStamped) {
      btnAddGood.addEventListener("click", function () {
        const idx = bumpTotal("goods");

        const emptyHidden = `{{ fs_goods.empty_form.hidden_fields|join:"" | escapejs }}`;
const emptyMerc = `{{ fs_goods.empty_form.mercancia|add_class:"form-control form-control-sm js-mercancia"|escapejs }}`;
const emptyUUIDCE = `{{ fs_goods.empty_form.comercio_exterior_uuid|escapejs }}`;
        const emptyCant   = `{{ fs_goods.empty_form.cantidad  | escapejs }}`;
        const emptyUni    = `{{ fs_goods.empty_form.unidad    | escapejs }}`;
        const emptyPeso   = `{{ fs_goods.empty_form.peso_en_kg| escapejs }}`;
        const emptyVal    = `{{ fs_goods.empty_form.valor_mercancia| escapejs }}`;
const emptyMon  = `{{ fs_goods.empty_form.moneda|add_class:"form-control form-control-sm js-moneda"|escapejs }}`;
        const emptyEmb    = `{{ fs_goods.empty_form.embalaje  | escapejs }}`;
        const emptyPed    = `{{ fs_goods.empty_form.pedimento | escapejs }}`;
        const emptyDelete = `{{ fs_goods.empty_form.DELETE    | escapejs }}`;

        function repl(s) { return (s || "").replaceAll("__prefix__", String(idx)); }

        let html = goodsTpl.innerHTML;
        html = html
          .replaceAll("__HIDDEN__",    repl(emptyHidden))
          .replaceAll("__MERCANCIA__", repl(emptyMerc))
          .replaceAll("__UUIDCE__",    repl(emptyUUIDCE))
          .replaceAll("__CANT__",      repl(emptyCant))
          .replaceAll("__UNIDAD__",    repl(emptyUni))
          .replaceAll("__PESO__",      repl(emptyPeso))
          .replaceAll("__VALOR__",     repl(emptyVal))
          .replaceAll("__MONEDA__",    repl(emptyMon))
          .replaceAll("__EMB__",       repl(emptyEmb))
          .replaceAll("__PEDIMENTO__", repl(emptyPed))
          .replaceAll("__DELETE__",    repl(emptyDelete));

        const tmp = document.createElement("tbody");
        tmp.innerHTML = html.trim();
        const newRow = tmp.firstElementChild;
        if (!newRow) return;

        goodsBody.appendChild(newRow);

        bindMercanciaAutofill(newRow);
        bindRemoveButtons(newRow);
        syncGoodsCtrlWidth();
      });
    }

    // ==========================
    // ✅ Submit: forzar hidden RAW (sin comas) para Django DecimalField
    // ==========================
    form?.addEventListener("submit", function () {
      recomputeConceptAndTotals();

      if (elSubtotal && elSubtotalUI) elSubtotal.value = String(parseMoney(elSubtotalUI.value || "0")).toFixed(2);
      if (elIVA && elIvaUI)           elIVA.value      = String(parseMoney(elIvaUI.value || "0")).toFixed(2);
      if (elRet && elRetUI)           elRet.value      = String(parseMoney(elRetUI.value || "0")).toFixed(2);
      if (elTotal && elTotalUI)       elTotal.value    = String(parseMoney(elTotalUI.value || "0")).toFixed(2);
    });

    // ==========================
    // ✅ Si está timbrado: bloquear todo al final
    // ==========================
    if (isStamped && form) {
      form.querySelectorAll("input, select, textarea").forEach(el => {
        if (el.type === "hidden") return;

        if (el.type === "checkbox" || el.type === "radio") {
          el.disabled = true;
          el.classList.add("cp-locked");
          return;
        }

        if (el.tagName === "SELECT") {
          el.disabled = true;
          el.classList.add("cp-locked");
          el.tabIndex = -1;
          return;
        }

        el.readOnly = true;
        el.classList.add("cp-locked");
        el.tabIndex = -1;
      });

      form.querySelectorAll(".js-remove-good, #btn-add-good, .loc-toggle").forEach(btn => {
        btn.disabled = true;
        btn.style.pointerEvents = "none";
        btn.classList.add("disabled");
      });

      form.querySelectorAll('button[type="submit"]').forEach(btn => {
        btn.disabled = true;
        btn.title = "Este CFDI ya fue timbrado y no puede modificarse.";
      });
    }
  });
})();
</script>


{% endblock %}
