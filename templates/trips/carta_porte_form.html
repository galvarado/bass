{# templates/trips/carta_porte_form.html #}
{% extends "base.html" %}
{% load form_extras %}

{% block title %}Carta Porte · Viaje #{{ trip.id }} · BASS{% endblock %}

{% block content %}

<style>
  .loc-collapse { display: none; }
  .loc-collapse.show { display: block; }

  .loc-toggle { text-decoration: none !important; }
  .loc-chevron { transition: transform .15s ease-in-out; }
  .loc-chevron.rotate-180 { transform: rotate(180deg); }

  .goods-mercancia select { min-width: 180px; }

  .cp-compact label { margin-bottom: .15rem; }
  .cp-compact .form-group { margin-bottom: .35rem; }
  .cp-compact input.form-control-sm,
  .cp-compact select.form-control-sm {
    padding-top: .15rem;
    padding-bottom: .15rem;
    height: calc(1.2em + .5rem + 2px);
  }

  .cp-totals .input-group-text {
    min-width: 90px;
    justify-content: flex-end;
  }

  .cp-w-itrn { max-width: 170px; }
  .cp-w-ped { max-width: 170px; }
  .cp-w-ord { max-width: 160px; }

  #goods-table td { padding: .25rem .35rem; vertical-align: middle; }
  #goods-table input.form-control-sm,
  #goods-table select.form-control-sm {
    height: 26px;
    padding: .10rem .35rem;
    font-size: .82rem;
    line-height: 1.1;
  }

  .w-merc { min-width: 150px; }
  .w-clv  { width: 100px; min-width:100px; }
  .w-cant { width: 90px;  min-width:90px;  }
  .w-und  { width: 120px; min-width:120px; }
  .w-emb  { width: 90px;  min-width:90px;  }
  .w-peso { width: 90px;  min-width:90px;  }
  .w-val  { width: 110px; min-width:110px; }
  .w-mon  { width: 70px;  min-width:70px;  text-transform: uppercase; }
  .w-frac { width: 130px; min-width:130px; }
  .w-uuid { width: 180px; min-width:180px; }
  .w-ped  { width: 100px; min-width:100px; }
  .w-del { width: 48px; min-width: 48px; }

  .cp-ro {
    background: #f6f7fb;
    border: 1px solid #dfe3ee;
    border-radius: 4px;
    padding: .20rem .35rem;
    height: 26px;
    display: flex;
    align-items: center;
    font-size: .82rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .js-remove-good{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:32px;
    height:26px;
    padding:0;
  }

  .goods-scroll-ctrl{
    overflow-x:auto;
    overflow-y:hidden;
    height:14px;
    border:1px solid #e6e8ef;
    border-radius:6px;
    background:#fff;
  }
  .goods-scroll-ctrl-inner{ height:1px; }

  #goods-scroll-wrap { scrollbar-width: none; }
  #goods-scroll-wrap::-webkit-scrollbar { height: 0; }

  /* ✅ barra de controles del concepto */
  .cpitem-taxbar { display:flex; gap:14px; align-items:center; flex-wrap: wrap; }
  .cpitem-taxbar .custom-control { margin-bottom: 0; }

  .form-control[readonly] { background: #f6f7fb; }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Carta Porte · Viaje #{{ trip.id }}</h1>
  <a href="{% url 'trips:detail' trip.id %}" class="btn btn-light btn-sm">
    <i class="fas fa-arrow-left"></i> Volver
  </a>
</div>

<form method="post" class="card shadow-sm">
  {% csrf_token %}

  <div class="card-body">

    {% if messages %}
      {% for m in messages %}
        <div class="alert alert-{{ m.tags }}">{{ m }}</div>
      {% endfor %}
    {% endif %}

    <h6 class="text-primary mb-2">
      <i class="fas fa-file-invoice mr-1"></i> Datos generales
    </h6>

    <div class="row cp-compact">
      <div class="col-md-12">
        <div class="form-row">

          <div class="form-group col-md-4">
            <label>Cliente (Paga)</label>
            {{ form.customer|add_class:"form-control form-control-sm" }}
          </div>

          <div class="form-group col-md-2">
            <label>Fecha salida</label>
            {{ form.fecha_salida|add_class:"form-control form-control-sm" }}
          </div>

          <div class="form-group col-md-2">
            <label>Fecha llegada</label>
            {{ form.fecha_llegada|add_class:"form-control form-control-sm" }}
          </div>

          <div class="form-group col-md-2">
            <label>US entry</label>
            {{ form.itrn_us_entry|add_class:"form-control form-control-sm cp-w-itrn" }}
          </div>

          <div class="form-group col-md-2">
            <label>Pedimento</label>
            {{ form.pedimento|add_class:"form-control form-control-sm cp-w-ped" }}
          </div>

        </div>
      </div>
    </div>

    <hr>
    <h6 class="text-primary mb-2">
      <i class="fas fa-route mr-1"></i> Datos del viaje
    </h6>

    <div class="form-row">
      <div class="form-group col-md-3">
        <label>Ruta</label>
        <input class="form-control form-control-sm" value="{{ trip.route }}" readonly>
      </div>
      <div class="form-group col-md-3">
        <label>Operador</label>
        <input class="form-control form-control-sm" value="{{ trip.operator }}" readonly>
      </div>
      <div class="form-group col-md-3">
        <label>Unidad - Caja</label>
        <input class="form-control form-control-sm" value="{{ trip.truck }} - {{ trip.reefer_box }}" readonly>
      </div>
    </div>

    <hr>
    <h6 class="text-primary mb-2">
      <i class="fas fa-map-marker-alt mr-1"></i> Origen / Destino
    </h6>

    {{ fs_locations.management_form }}

    <div id="loc-forms">
      {% for f in fs_locations.forms %}
        <div class="border rounded mb-2 loc-form">
          {{ f.id }}

          <div class="d-none">
            {{ f.tipo_ubicacion }}
            {{ f.orden }}
          </div>

          <button type="button"
                  class="btn btn-link btn-block text-left py-2 px-2 d-flex justify-content-between align-items-center loc-toggle"
                  data-target="#loc-{{ forloop.counter0 }}"
                  aria-controls="loc-{{ forloop.counter0 }}"
                  aria-expanded="false">

            <div class="d-flex align-items-center">
              {% if f.instance.tipo_ubicacion == "Origen" %}
                <span class="badge badge-success mr-2">Origen</span>
              {% else %}
                <span class="badge badge-primary mr-2">Destino</span>
              {% endif %}

              <span class="text-dark font-weight-bold">
                {{ f.nombre.value|default:f.instance.nombre|default:"(sin nombre)" }}
              </span>

              {% if f.localidad.value or f.instance.localidad %}
                <span class="text-muted ml-2 small">
                  · {{ f.localidad.value|default:f.instance.localidad }}
                </span>
              {% endif %}
            </div>

            <i class="fas fa-chevron-down text-muted loc-chevron"></i>
          </button>

          <div id="loc-{{ forloop.counter0 }}" class="loc-collapse px-2 pb-2">

            <div class="form-row mt-2">
              <div class="form-group col-md-4">
                <label>Cliente</label>
                {% if f.instance.tipo_ubicacion == "Origen" %}
                  <input class="form-control form-control-sm" value="{{ trip.route.origen.client.nombre }}" readonly>
                {% else %}
                  <input class="form-control form-control-sm" value="{{ trip.route.destino.client.nombre }}" readonly>
                {% endif %}
              </div>

              <div class="form-group col-md-4">
                <label>Ubicación</label>
                {{ f.nombre|add_class:"form-control form-control-sm loc-ro" }}
              </div>

              <div class="form-group col-md-4">
                <label>Población</label>
                {{ f.localidad|add_class:"form-control form-control-sm loc-ro" }}
              </div>
            </div>

            <div class="form-row">
              <div class="form-group col-md-4">
                <label>Calle</label>
                {{ f.calle|add_class:"form-control form-control-sm loc-ro" }}
              </div>

              <div class="form-group col-md-4">
                <label>No. exterior</label>
                {{ f.numero_exterior|add_class:"form-control form-control-sm loc-ro" }}
              </div>
            </div>

            <div class="form-row">
              <div class="form-group col-md-4">
                <label>Colonia</label>
                {{ f.colonia|add_class:"form-control form-control-sm loc-ro" }}
              </div>

              <div class="form-group col-md-4">
                <label>Municipio</label>
                {{ f.municipio|add_class:"form-control form-control-sm loc-ro" }}
              </div>

              <div class="form-group col-md-4">
                <label>Estado</label>
                {{ f.estado|add_class:"form-control form-control-sm loc-ro" }}
              </div>
            </div>

            <div class="form-row">
              <div class="form-group col-md-4">
                <label>País</label>
                {{ f.pais|add_class:"form-control form-control-sm loc-ro" }}
              </div>

              <div class="form-group col-md-4">
                <label>CP</label>
                {{ f.codigo_postal|add_class:"form-control form-control-sm loc-ro" }}
              </div>
            </div>

          </div>
        </div>
      {% endfor %}
    </div>

    <hr>

    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="text-primary mb-0">
        <i class="fas fa-boxes mr-1"></i> Mercancías
      </h6>
      <button type="button" class="btn btn-outline-primary btn-sm" id="btn-add-good">
        <i class="fas fa-plus"></i> Agregar mercancía
      </button>
    </div>

    {{ fs_goods.management_form }}

    <div class="table-responsive" id="goods-scroll-wrap">
      <table class="table table-sm table-bordered mb-0" id="goods-table">
        <thead class="thead-light">
          <tr>
            <th class="w-merc">Mercancía</th>
            <th class="w-clv">Clave</th>
            <th class="w-frac">Fracción arancelaria</th>
            <th class="w-uuid">UUID comercio exterior</th>
            <th class="w-cant">Cantidad</th>
            <th class="w-und">Unidad</th>
            <th class="w-peso">Peso</th>
            <th class="w-val">Valor</th>
            <th class="w-mon">Moneda</th>
            <th class="w-emb">Embalaje</th>
            <th class="w-ped">Pedimento</th>
            <th class="w-del text-center">✕</th>
          </tr>
        </thead>

        <tbody id="goods-rows">
          {% for f in fs_goods.forms %}
          <tr class="goods-row">
            <td class="w-merc goods-mercancia">
              {{ f.mercancia|add_class:"form-control form-control-sm js-mercancia" }}
              {{ f.id }}
            </td>

            <td class="w-clv"><div class="cp-ro js-clave"></div></td>
            <td class="w-frac"><div class="cp-ro js-fraccion"></div></td>
            <td class="w-uuid"><div class="cp-ro js-uuidce"></div></td>
            <td class="w-cant">{{ f.cantidad|add_class:"form-control form-control-sm" }}</td>
            <td class="w-und">{{ f.unidad|add_class:"form-control form-control-sm" }}</td>
            <td class="w-peso">{{ f.peso_en_kg|add_class:"form-control form-control-sm" }}</td>
            <td class="w-val">{{ f.valor_mercancia|add_class:"form-control form-control-sm" }}</td>
            <td class="w-mon">{{ f.moneda|add_class:"form-control form-control-sm js-moneda" }}</td>
            <td class="w-emb">{{ f.embalaje|add_class:"form-control form-control-sm" }}</td>
            <td class="w-ped">{{ f.pedimento|add_class:"form-control form-control-sm" }}</td>

            <td class="w-del text-center align-middle">
              <div class="d-none">
                {{ f.DELETE }}
              </div>
              <button type="button"
                      class="btn btn-sm btn-outline-danger js-remove-good"
                      title="Quitar mercancía">
                <i class="fas fa-trash-alt"></i>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <template id="goods-empty-row">
      <tr class="goods-row">
        <td class="w-merc goods-mercancia">__MERCANCIA____ID__</td>
        <td class="w-clv"><div class="cp-ro js-clave"></div></td>
        <td class="w-frac"><div class="cp-ro js-fraccion"></div></td>
        <td class="w-uuid"><div class="cp-ro js-uuidce"></div></td>

        <td class="w-cant">__CANT__</td>
        <td class="w-und">__UNIDAD__</td>
        <td class="w-peso">__PESO__</td>
        <td class="w-val">__VALOR__</td>
        <td class="w-mon">__MONEDA__</td>
        <td class="w-emb">__EMB__</td>

        <td class="w-ped">__PEDIMENTO__</td>
        <td class="w-del text-center align-middle">
          <div class="d-none">__DELETE__</div>
          <button type="button"
                  class="btn btn-sm btn-outline-danger js-remove-good"
                  title="Quitar mercancía">
            <i class="fas fa-trash-alt"></i>
          </button>
        </td>
      </tr>
    </template>

    <div class="goods-scroll-ctrl my-2" id="goods-scroll-ctrl" aria-label="Scroll horizontal mercancías">
      <div class="goods-scroll-ctrl-inner"></div>
    </div>

    <hr>
    <h6 class="text-primary mb-2">
      <i class="fas fa-file-invoice mr-1"></i> Complemento Carta de Porte
    </h6>

    <div class="row cp-compact">
      <div class="col-md-12">
        <div class="form-row">
          <div class="form-group col-md-3">
            <label>Método de pago</label>
            {{ form.payment_method|add_class:"form-control form-control-sm" }}
          </div>
          <div class="form-group col-md-3">
            <label>Forma de pago</label>
            {{ form.payment_form|add_class:"form-control form-control-sm" }}
          </div>
          <div class="form-group col-md-2">
            <label>Moneda</label>
            {{ form.currency|add_class:"form-control form-control-sm" }}
          </div>
          <div class="form-group col-md-2">
            <label>Tipo</label>
            {{ form.type|add_class:"form-control form-control-sm" }}
          </div>
          <div class="form-group col-md-2">
            <label>Uso CFDI</label>
            {{ form.uso_cfdi|add_class:"form-control form-control-sm" }}
          </div>
          <div class="form-group col-md-4">
            <label>Observaciones</label>
            {{ form.observations|add_class:"form-control form-control-sm" }}
          </div>
        </div>
      </div>
    </div>

    <hr class="my-2">

    {# ========================================= #}
    {# ✅ CONCEPTO + checkboxes (default OFF)      #}
    {# ========================================= #}
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="text-primary mb-0">
        <i class="fas fa-list mr-1"></i> Concepto
      </h6>

      <div class="cpitem-taxbar">
        <div class="custom-control custom-checkbox">
          <input type="checkbox" class="custom-control-input" id="chk-item-iva16">
          <label class="custom-control-label small" for="chk-item-iva16">Aplicar 16% IVA</label>
        </div>

        <div class="custom-control custom-checkbox">
          <input type="checkbox" class="custom-control-input" id="chk-item-retiva">
          <label class="custom-control-label small" for="chk-item-retiva">Aplicar retención IVA (4%)</label>
        </div>

        <div class="custom-control custom-checkbox">
          <input type="checkbox" class="custom-control-input" id="chk-item-desc">
          <label class="custom-control-label small" for="chk-item-desc">Aplicar descuento</label>
        </div>
      </div>
    </div>

    {{ fs_items.management_form }}

    <div class="table-responsive" id="cpitems-scroll-wrap">
      <table class="table table-sm table-bordered mb-0" id="cpitems-table">
        <thead class="thead-light">
          <tr>
            <th style="min-width:90px;">Cantidad</th>
            <th style="min-width:130px;">Unidad</th>
            <th style="min-width:160px;">Producto</th>
            <th style="min-width:220px;">Descripción</th>
            <th style="min-width:110px;">Precio</th>
            <th style="min-width:110px;">Descuento</th>
            <th style="min-width:120px;">Subtotal</th>
            <th style="min-width:90px;">IVA %</th>
            <th style="min-width:120px;">IVA monto</th>
            <th style="min-width:90px;">Ret IVA %</th>
            <th style="min-width:150px;">Ret IVA monto</th>
            <th style="min-width:120px;">Importe</th>
          </tr>
        </thead>

        <tbody id="cpitems-rows">
          {% for f in fs_items.forms %}
          <tr class="cpitem-row">
            <td>{{ f.cantidad }}</td>
            <td>{{ f.unidad }}</td>
            <td>{{ f.producto }}</td>
            <td>{{ f.descripcion }}</td>
            <td>{{ f.precio }}</td>
            <td>{{ f.descuento }}</td>

            <td><input class="form-control form-control-sm text-right js-item-subtotal-ui" value="{{ f.instance.subtotal|default_if_none:'0.00' }}" readonly></td>
            <td>{{ f.iva_pct }}</td>
            <td><input class="form-control form-control-sm text-right js-item-iva-ui" value="{{ f.instance.iva_monto|default_if_none:'0.00' }}" readonly></td>
            <td>{{ f.ret_iva_pct }}</td>
            <td><input class="form-control form-control-sm text-right js-item-ret-ui" value="{{ f.instance.ret_iva_monto|default_if_none:'0.00' }}" readonly></td>
            <td><input class="form-control form-control-sm text-right js-item-imp-ui" value="{{ f.instance.importe|default_if_none:'0.00' }}" readonly></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <hr>

    <div class="row">
      <div class="col-md-9"></div>
      <div class="col-md-3 cp-totals">
        <div class="form-group mb-0">
          <label class="mb-1">Totales</label>

          <div class="input-group input-group-sm mb-1">
            <div class="input-group-prepend">
              <span class="input-group-text">Subtotal $</span>
            </div>

            <input type="text"
                   class="form-control form-control-sm js-subtotal-ui text-right"
                   value="{{ form.subtotal.value|default_if_none:'0.00' }}"
                   readonly>

            <input type="hidden" name="subtotal" class="js-subtotal">
          </div>

          <div class="input-group input-group-sm mb-1">
            <div class="input-group-prepend">
              <span class="input-group-text">IVA $</span>
            </div>

            <input type="text"
                   class="form-control form-control-sm js-iva-ui text-right"
                   value="{{ form.iva.value|default_if_none:'0.00' }}"
                   readonly>

            <input type="hidden" name="iva" class="js-iva">
          </div>

          <div class="input-group input-group-sm mb-1">
            <div class="input-group-prepend">
              <span class="input-group-text">Ret $</span>
            </div>

            <input type="text"
                   class="form-control form-control-sm js-retencion-ui text-right"
                   value="{{ form.retencion.value|default_if_none:'0.00' }}"
                   readonly>

            <input type="hidden" name="retencion" class="js-retencion">
          </div>

          <div class="input-group input-group-sm">
            <div class="input-group-prepend">
              <span class="input-group-text">Total $</span>
            </div>

            <input type="text"
                   class="form-control form-control-sm js-total-ui text-right"
                   value="{{ form.total.value|default_if_none:'0.00' }}"
                   readonly>

            <input type="hidden" name="total" class="js-total">
          </div>
        </div>
      </div>
    </div>

  </div>

<div class="card-footer d-flex justify-content-end gap-2 py-2">
  <button class="btn btn-primary btn-sm" type="submit" name="action" value="save">
    <i class="fas fa-save"></i> Guardar
  </button>
&nbsp;
  <button class="btn btn-success btn-sm" type="submit" name="action" value="generate_cfdi">
    <i class="fas fa-file-invoice"></i> Generar CFDI
  </button>
</div>
</form>

<script>
(function () {
  function ready(fn){
    if (document.readyState !== "loading") fn();
    else document.addEventListener("DOMContentLoaded", fn);
  }

  ready(function () {

    // ==========================
    // Readonly ubicaciones
    // ==========================
    document.querySelectorAll(".loc-ro").forEach(el => {
      if (el.tagName === "SELECT") el.disabled = true;
      else el.readOnly = true;
    });

    // ==========================
    // Collapse Origen/Destino (sin bootstrap)
    // ==========================
    function togglePanel(btn) {
      let targetSel = (btn.getAttribute("data-target") || "").trim();
      if (!targetSel) return;
      if (!targetSel.startsWith("#")) targetSel = "#" + targetSel;

      const panel = document.querySelector(targetSel);
      if (!panel) return;

      const open = !panel.classList.contains("show");
      panel.classList.toggle("show", open);

      const chevron = btn.querySelector(".loc-chevron");
      if (chevron) chevron.classList.toggle("rotate-180", open);

      btn.setAttribute("aria-expanded", open ? "true" : "false");
    }

    document.querySelectorAll(".loc-toggle").forEach(btn => {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        e.stopPropagation();
        togglePanel(btn);
      });
    });

    // ==========================
    // Utils dinero
    // ==========================
    function parseMoney(raw) {
      if (raw === null || raw === undefined) return 0;
      let s = String(raw).trim();
      if (!s) return 0;

      s = s.replace(/\u00A0/g, " ").replace(/\s/g, "").replace(/\$/g, "");
      s = s.replace(/[^\d.,-]/g, "");

      const lastComma = s.lastIndexOf(",");
      const lastDot = s.lastIndexOf(".");

      if (lastComma !== -1 && lastDot !== -1) {
        const decSep = lastComma > lastDot ? "," : ".";
        const thouSep = decSep === "," ? "." : ",";
        s = s.split(thouSep).join("");
        if (decSep === ",") s = s.replace(",", ".");
      } else if (lastComma !== -1 && lastDot === -1) {
        const parts = s.split(",");
        if (parts.length === 2 && parts[1].length <= 2) s = parts[0] + "." + parts[1];
        else s = s.replace(/,/g, "");
      } else {
        s = s.replace(/,/g, "");
      }

      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }

    function round2(n) {
      return Math.round((n + Number.EPSILON) * 100) / 100;
    }

    const uiFmt = new Intl.NumberFormat("en-US", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    });

    function setHidden(hiddenEl, n) {
      if (!hiddenEl) return;
      hiddenEl.value = round2(n).toFixed(2);
    }

    function setUI(uiEl, n) {
      if (!uiEl) return;
      uiEl.value = uiFmt.format(round2(n));
    }

    // ==========================
    // Totales (NO editables)
    // ==========================
    const elSubtotalUI = document.querySelector(".js-subtotal-ui");
    const elIvaUI      = document.querySelector(".js-iva-ui");
    const elRetUI      = document.querySelector(".js-retencion-ui");
    const elTotalUI    = document.querySelector(".js-total-ui");

    const elSubtotal = document.querySelector(".js-subtotal");
    const elIVA      = document.querySelector(".js-iva");
    const elRet      = document.querySelector(".js-retencion");
    const elTotal    = document.querySelector(".js-total");

    // ✅ forzar totales readonly
    [elSubtotalUI, elIvaUI, elRetUI, elTotalUI].forEach(x => { if (x) x.readOnly = true; });

    function recomputeTotalFromHidden() {
      const subtotal = parseMoney(elSubtotal?.value || "0");
      const iva      = parseMoney(elIVA?.value || "0");
      const ret      = parseMoney(elRet?.value || "0");

      const total = subtotal + iva - ret;

      setHidden(elTotal, total);
      setUI(elTotalUI, total);

      // UI de subtotal/iva/ret desde hidden (por consistencia)
      setUI(elSubtotalUI, subtotal);
      setUI(elIvaUI, iva);
      setUI(elRetUI, ret);
    }

    // init hidden desde UI inicial
    setHidden(elSubtotal, parseMoney(elSubtotalUI?.value || "0"));
    setHidden(elIVA,      parseMoney(elIvaUI?.value || "0"));
    setHidden(elRet,      parseMoney(elRetUI?.value || "0"));
    recomputeTotalFromHidden();

    // ==========================
    // Helpers 1 concepto
    // ==========================
    function firstRow() {
      return document.querySelector("#cpitems-rows .cpitem-row");
    }

    function getFieldBySuffix(suffix) {
      const tr = firstRow();
      if (!tr) return null;
      return tr.querySelector(`[name$="-${suffix}"]`) || null;
    }

    function getReadonlyCellInputByIndex(idx) {
      const tr = firstRow();
      if (!tr) return null;
      const tds = tr.querySelectorAll("td");
      if (!tds || !tds[idx]) return null;
      return tds[idx].querySelector("input") || null;
    }

    // Campos editables (del item)
    const elCant    = () => getFieldBySuffix("cantidad");
    const elPrecio  = () => getFieldBySuffix("precio");
    const elDesc    = () => getFieldBySuffix("descuento");
    const elIvaPct  = () => getFieldBySuffix("iva_pct");
    const elRetPct  = () => getFieldBySuffix("ret_iva_pct");

    // Display-only (por indices según tu tabla)
    const elSubUI    = () => getReadonlyCellInputByIndex(6);
    const elIvaMonto = () => getReadonlyCellInputByIndex(8);
    const elRetMonto = () => getReadonlyCellInputByIndex(10);
    const elImpUI    = () => getReadonlyCellInputByIndex(11);

    function setField(el, v) {
      if (!el) return;
      el.value = v;
    }

    function valNum(el) {
      if (!el) return 0;
      return parseMoney(el.value);
    }

    function clamp0(n){ return n < 0 ? 0 : n; }

    // ==========================
    // ✅ Checkboxes (IDs reales en tu HTML)
    // - chk-item-iva16
    // - chk-item-retiva   <-- OJO: en tu HTML es "chk-item-retiva" (no retiva4)
    // - chk-item-desc
    // ==========================
    const chkIVA16  = document.getElementById("chk-item-iva16");
    const chkRET4   = document.getElementById("chk-item-retiva"); // ✅ corregido
    const chkDESC   = document.getElementById("chk-item-desc");

    // defaults OFF
    if (chkIVA16) chkIVA16.checked = false;
    if (chkRET4) chkRET4.checked = false;
    if (chkDESC) chkDESC.checked = false;

    // ==========================
    // ✅ Reglas UI:
    // - precio readonly SIEMPRE
    // - totales abajo readonly SIEMPRE
    // - IVA: checkbox pone iva_pct=16 o 0 y recalcula iva_monto y totales
    // - RET: checkbox pone ret_pct=4 o 0; ret_pct editable SOLO si checkbox ON
    //        ret_monto recalcula al teclear ret_pct
    // - DESCUENTO: checkbox habilita input descuento (si OFF => 0 y readonly)
    // ==========================
    function enforceLocks() {
      // precio siempre bloqueado (pero se manda en POST)
      const p = elPrecio();
      if (p) {
        p.readOnly = true;
        p.tabIndex = -1;
      }

      // inputs calculados siempre readonly
      [elSubUI(), elIvaMonto(), elRetMonto(), elImpUI()].forEach(x => { if (x) x.readOnly = true; });

      // iva_pct: se controla por checkbox
      const ip = elIvaPct();
      if (ip) ip.readOnly = true;

      // ret_pct: editable SOLO si checkbox ON
      // ⚠️ usamos disabled para bloquear input, pero cuando está ON lo habilitamos para que sí se mande en POST
      const rp = elRetPct();
      if (rp) {
        const on = (chkRET4 && chkRET4.checked);
        rp.readOnly = !on;
        rp.disabled = !on;
      }

      // descuento: editable SOLO si checkbox ON
      const d = elDesc();
      if (d) {
        const on = (chkDESC && chkDESC.checked);
        d.readOnly = !on;
        d.disabled = !on;
      }
    }

    function recomputeItemUI() {
      const qty = valNum(elCant());
      const price = valNum(elPrecio());
      const disc = clamp0(valNum(elDesc()));

      const base = round2(qty * price);
      const sub = round2(clamp0(base - disc));

      // IVA: depende del checkbox (no del value previo)
      const ivaPct = (chkIVA16 && chkIVA16.checked) ? 16.0 : 0.0;
      if (elIvaPct()) setField(elIvaPct(), ivaPct.toFixed(2));

      // RET: depende del checkbox (si OFF => 0 aunque el input tenga algo)
      const retPct = (chkRET4 && chkRET4.checked) ? valNum(elRetPct()) : 0.0;

      const ivaMonto = round2(sub * (ivaPct / 100));
      const retMonto = round2(sub * (retPct / 100));
      const importe  = round2(sub + ivaMonto - retMonto);

      // pinta display-only
      if (elSubUI()) setUI(elSubUI(), sub);
      if (elIvaMonto()) setUI(elIvaMonto(), ivaMonto);
      if (elRetMonto()) setUI(elRetMonto(), retMonto);
      if (elImpUI()) setUI(elImpUI(), importe);

      // sincroniza totales hidden (1 concepto => totals = item)
      setHidden(elSubtotal, sub);
      setHidden(elIVA, ivaMonto);
      setHidden(elRet, retMonto);
      recomputeTotalFromHidden();
    }

    function enforceDefaultsOff() {
      if (elIvaPct()) setField(elIvaPct(), "0.00");
      if (elRetPct()) setField(elRetPct(), "0.00");
      if (elDesc()) setField(elDesc(), "0.00");
      enforceLocks();
      recomputeItemUI();
    }

    enforceDefaultsOff();

    // ==========================
    // Bind cambios de checkboxes
    // ==========================
    if (chkIVA16) {
      chkIVA16.addEventListener("change", function () {
        // iva_pct se fuerza dentro de recomputeItemUI
        enforceLocks();
        recomputeItemUI();
      });
    }

    if (chkRET4) {
      chkRET4.addEventListener("change", function () {
        const rp = elRetPct();
        if (rp) {
          if (chkRET4.checked) {
            rp.disabled = false;
            rp.readOnly = false;
            rp.value = "4.00"; // default 4%
          } else {
            rp.value = "0.00";
            rp.readOnly = true;
            rp.disabled = true;
          }
        }
        enforceLocks();
        recomputeItemUI();
      });
    }

    if (chkDESC) {
      chkDESC.addEventListener("change", function () {
        const d = elDesc();
        if (d) {
          if (chkDESC.checked) {
            d.disabled = false;
            d.readOnly = false;
            // no tocamos el valor
          } else {
            d.value = "0.00";
            d.readOnly = true;
            d.disabled = true;
          }
        }
        enforceLocks();
        recomputeItemUI();
      });
    }

    // ==========================
    // Bind inputs que sí cambian cálculos
    // ==========================
    function bindRecalc(el) {
      if (!el) return;
      el.addEventListener("input", () => recomputeItemUI());
      el.addEventListener("blur",  () => recomputeItemUI());
    }

    bindRecalc(elCant());
    bindRecalc(elDesc());
    bindRecalc(elRetPct()); // solo funciona cuando checkbox ON (porque entonces está habilitado)

    // ==========================
    // ✅ Control horizontal mercancías (sync)
    // ==========================
    const goodsWrap = document.getElementById("goods-scroll-wrap");
    const goodsCtrl = document.getElementById("goods-scroll-ctrl");
    const goodsCtrlInner = goodsCtrl?.querySelector(".goods-scroll-ctrl-inner");
    const goodsTable = document.getElementById("goods-table");

    function syncGoodsCtrlWidth() {
      if (!goodsCtrlInner || !goodsTable) return;
      goodsCtrlInner.style.width = goodsTable.scrollWidth + "px";
    }

    let syncingScroll = false;
    function bindGoodsScrollSync() {
      if (!goodsWrap || !goodsCtrl) return;

      goodsCtrl.addEventListener("scroll", () => {
        if (syncingScroll) return;
        syncingScroll = true;
        goodsWrap.scrollLeft = goodsCtrl.scrollLeft;
        syncingScroll = false;
      });

      goodsWrap.addEventListener("scroll", () => {
        if (syncingScroll) return;
        syncingScroll = true;
        goodsCtrl.scrollLeft = goodsWrap.scrollLeft;
        syncingScroll = false;
      });
    }

    bindGoodsScrollSync();

    function hardSyncGoodsCtrl() {
      syncGoodsCtrlWidth();
      if (goodsCtrl && goodsWrap) goodsCtrl.scrollLeft = goodsWrap.scrollLeft;
    }

    hardSyncGoodsCtrl();
    requestAnimationFrame(hardSyncGoodsCtrl);
    setTimeout(hardSyncGoodsCtrl, 50);
    setTimeout(hardSyncGoodsCtrl, 250);
    window.addEventListener("load", hardSyncGoodsCtrl);
    window.addEventListener("resize", hardSyncGoodsCtrl);
    syncGoodsCtrlWidth();
    window.addEventListener("resize", syncGoodsCtrlWidth);

    // ==========================
    // Formset helpers (mercancías)
    // ==========================
    function bumpTotal(prefix) {
      const totalInput = document.querySelector(`input[name="${prefix}-TOTAL_FORMS"]`);
      if (!totalInput) return 0;
      const current = parseInt(totalInput.value || "0", 10);
      totalInput.value = String(current + 1);
      return current;
    }

    function replaceAll(html, repls) {
      let out = html;
      for (const [k, v] of Object.entries(repls)) out = out.split(k).join(v);
      return out;
    }

    function fieldControlsHTMLFromEmpty(emptyHtml, fieldName) {
      const wrapper = document.createElement("div");
      wrapper.innerHTML = emptyHtml;

      const el = wrapper.querySelector(`[name="${fieldName}"]`);
      if (!el) return "";

      const p = el.closest("p");
      if (p) {
        return Array.from(p.querySelectorAll("input,select,textarea"))
          .map(x => x.outerHTML)
          .join("");
      }
      return el.outerHTML;
    }

    const cartaCurrency = "{{ form.currency.value|default_if_none:'' }}";

    function fillDiv(divEl, value) {
      if (!divEl) return;
      divEl.textContent = (value || "").trim();
      divEl.title = divEl.textContent || "";
    }

    function bindMercanciaAutofill(scopeEl) {
      const root = scopeEl || document;
      root.querySelectorAll("select.js-mercancia").forEach(sel => {
        if (sel.dataset.autofillBound === "1") return;
        sel.dataset.autofillBound = "1";

        sel.addEventListener("change", function () {
          const opt = sel.options[sel.selectedIndex];
          if (!opt) return;

          const tr = sel.closest("tr");
          if (!tr) return;

          const vClave = opt.getAttribute("data-clave") || "";
          const vFrac  = opt.getAttribute("data-fraccion") || "";
          const vUUID  = opt.getAttribute("data-uuidce") || "";

          fillDiv(tr.querySelector(".js-clave"), vClave);
          fillDiv(tr.querySelector(".js-fraccion"), vFrac);
          fillDiv(tr.querySelector(".js-uuidce"), vUUID);

          const elMoneda = tr.querySelector("select.js-moneda");
          if (elMoneda && !String(elMoneda.value || "").trim() && cartaCurrency) {
            elMoneda.value = cartaCurrency;
          }
        });

        if (sel.value) sel.dispatchEvent(new Event("change", { bubbles: true }));
      });
    }

    function bindRemoveButtons(scopeEl) {
      const root = scopeEl || document;
      root.querySelectorAll(".js-remove-good").forEach(btn => {
        if (btn.dataset.removeBound === "1") return;
        btn.dataset.removeBound = "1";

        btn.addEventListener("click", function () {
          const tr = btn.closest("tr");
          if (!tr) return;

          const del = tr.querySelector('input[type="checkbox"][name$="-DELETE"]');
          if (del) {
            del.checked = true;
            tr.style.display = "none";
          } else {
            tr.remove();
          }

          syncGoodsCtrlWidth();
        });
      });
    }

    // Bind inicial mercancías
    bindMercanciaAutofill(document);
    bindRemoveButtons(document);

    // ==========================
    // Agregar mercancía (prefix = goods)
    // ==========================
    const btnAddGood = document.getElementById("btn-add-good");
    const goodsBody = document.getElementById("goods-rows");
    const goodsTpl = document.getElementById("goods-empty-row");

    btnAddGood?.addEventListener("click", function () {
      const idx = bumpTotal("goods");
      const empty = `{{ fs_goods.empty_form.as_p|escapejs }}`;

      function field(shortName) {
        const name = `goods-__prefix__-${shortName}`;
        return fieldControlsHTMLFromEmpty(empty, name).replaceAll("__prefix__", String(idx));
      }

      let html = goodsTpl.innerHTML;
      html = replaceAll(html, {
        "__MERCANCIA__": field("mercancia"),
        "__CANT__": field("cantidad"),
        "__UNIDAD__": field("unidad"),
        "__EMB__": field("embalaje"),
        "__PESO__": field("peso_en_kg"),
        "__VALOR__": field("valor_mercancia"),
        "__MONEDA__": field("moneda"),
        "__PEDIMENTO__": field("pedimento"),
        "__DELETE__": field("DELETE"),
        "__ID__": field("id"),
      });

      const tr = document.createElement("tr");
      tr.innerHTML = html;
      goodsBody.appendChild(tr);

      // fix checkbox delete
      const del = tr.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (del) {
        const lbl = tr.querySelector(`label[for="${del.id}"]`);
        if (lbl) lbl.remove();
        del.classList.add("d-none");
        del.tabIndex = -1;
        del.setAttribute("aria-hidden", "true");
        const p = del.closest("p");
        if (p) p.classList.add("d-none");
      }

      bindMercanciaAutofill(tr);
      bindRemoveButtons(tr);
      syncGoodsCtrlWidth();
    });

    // ==========================
    // Submit: asegurar hidden totales van bien
    // ==========================
    const formEl = document.querySelector("form");
    formEl?.addEventListener("submit", function () {
      recomputeItemUI();          // 1 concepto => hidden totales correctos
      recomputeTotalFromHidden(); // refresca UI totales
    });

  });
})();
</script>



{% endblock %}
