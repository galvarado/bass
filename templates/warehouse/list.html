{# templates/locations/list.html #}
{% extends "base.html" %}
{% load currency_extras %}

{% block title %}Ubicaciones · BASS{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Ubicaciones y Rutas</h1>
  <div class="btn-group">
    <a class="btn btn-primary" href="{% url 'locations:create' %}">
      <i class="fas fa-plus"></i> Nueva ubicación
    </a>&nbsp;&nbsp;
    <a class="btn btn-primary" href="{% url 'routes:create' %}">
      <i class="fas fa-route"></i> Nueva ruta
    </a>
  </div>
</div>

<form method="get" class="card mb-3">
  <div class="card-body py-3">
    <div class="form-row align-items-center form-compact">
      <div class="col-md-8 mb-2">
        <div class="input-group input-group-sm">
          {{ search_form.q }}
          <div class="input-group-append">
            <button class="btn btn-outline-primary" type="submit">
              <i class="fas fa-search"></i> Buscar
            </button>
          </div>
        </div>
      </div>

      <div class="col-md-4 mb-2 text-right d-none d-md-block text-muted small">
        Mostrando {{ locations|length }} ubicación{{ locations|length|pluralize:"es" }}
        · {{ routes|length }} ruta{{ routes|length|pluralize:"s" }}
      </div>
    </div>

    {# Si tienes filtro de status, lo ponemos abajo como en otros módulos #}
    {% if search_form.status %}
    <div class="form-row align-items-center form-compact mt-2">
      <div class="col-md-3 mb-2">
        {{ search_form.status }}
      </div>
      <div class="col-md-9 mb-2 d-none d-md-block"></div>
    </div>
    {% endif %}
  </div>
</form>

<ul class="nav nav-tabs mb-3" id="locationsTabs" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="tab-locations" data-toggle="tab" href="#pane-locations" role="tab">
      <i class="fas fa-map-marker-alt"></i> Ubicaciones
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="tab-routes" data-toggle="tab" href="#pane-routes" role="tab">
      <i class="fas fa-route"></i> Rutas
    </a>
  </li>
</ul>

<div class="tab-content" id="locationsTabsContent">

  <!-- ===== UBICACIONES ===== -->
  <div class="tab-pane fade show active" id="pane-locations" role="tabpanel">
    <div class="card">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="thead-light">
            <tr>
              <th>Ubicación / Cliente</th>
              <th>Dirección</th>
              <th>Contacto</th>
              <th>Status</th>
              <th style="width: 120px;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for l in locations %}
              <tr>
                <td>
                  <a href="{% url 'locations:detail' l.pk %}">
                    {{ l.nombre }}
                  </a>
                  <br><small class="text-muted">{{ l.client.nombre }}</small>
                </td>

                <td>
                  {% if l.full_address %}
                    {{ l.full_address }}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                  {% if l.poblacion %}
                    <br><small class="text-muted">Población: {{ l.poblacion }}</small>
                  {% endif %}
                </td>

                <td>
                  {% if l.contacto or l.telefono or l.email %}
                    {% if l.contacto %}{{ l.contacto }}{% endif %}
                    {% if l.telefono %}<br><small class="text-muted"><i class="fas fa-phone"></i> {{ l.telefono }}</small>{% endif %}
                    {% if l.email %}<br><small class="text-muted"><i class="fas fa-envelope"></i> {{ l.email }}</small>{% endif %}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>

                <td>
                  {% if l.deleted %}
                    <span class="badge badge-danger">Eliminada</span>
                  {% else %}
                    <span class="badge badge-success">Activa</span>
                  {% endif %}
                </td>

                <td class="text-right">
                  <a href="{% url 'locations:edit' l.pk %}" class="btn btn-sm btn-outline-secondary" title="Editar">
                    <i class="fas fa-edit"></i>
                  </a>
                  <a href="{% url 'locations:delete' l.pk %}" class="btn btn-sm btn-outline-danger" title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted py-4">Sin resultados.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== RUTAS ===== -->
  <div class="tab-pane fade" id="pane-routes" role="tabpanel">
    <div class="card">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="thead-light">
            <tr>
              <th style="width: 22%;">Ruta / Cliente</th>
              <th style="width: 18%;">Origen</th>
              <th style="width: 18%;">Destino</th>
              <th style="width: 18%;">Cobro</th>
              <th style="width: 18%;">Pago operador</th>
              <th style="width: 8%;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for r in routes %}
              <tr>
                <td>
                  <a href="{% url 'routes:detail' r.pk %}">
                    {{ r.display_name|default:r.nombre }}
                  </a>
                  <br><small class="text-muted">{{ r.client.nombre }}</small>
                </td>

                <td>
                  {{ r.origen.nombre }}
                  {% if r.origen.poblacion %}
                    <br><small class="text-muted">{{ r.origen.poblacion }}</small>
                  {% endif %}
                </td>

                <td>
                  {{ r.destino.nombre }}
                  {% if r.destino.poblacion %}
                    <br><small class="text-muted">{{ r.destino.poblacion }}</small>
                  {% endif %}
                </td>

                <td>
                  {% if r.tarifa_cliente %}
                    ${{ r.tarifa_cliente|money_mx }}
                    {% if r.casetas_estimadas %}
                      <br><small class="text-muted">Casetas: ${{ r.casetas_estimadas|money_mx }}</small>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>

                <td>
                  {% if r.pago_operador %}
                    ${{ r.pago_operador|money_mx }}
                    {% if r.bono_operador %}
                      <br><small class="text-muted">Bono: ${{ r.bono_operador|money_mx }}</small>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>

                <td class="text-right">
                  <a href="{% url 'routes:edit' r.pk %}" class="btn btn-sm btn-outline-secondary" title="Editar">
                    <i class="fas fa-edit"></i>
                  </a>
                  <a href="{% url 'routes:delete' r.pk %}" class="btn btn-sm btn-outline-danger" title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted py-4">No hay rutas registradas.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

{% endblock %}
