{% extends "base.html" %}
{% load currency_extras %}

{% block title %}Refacciones y Compras · BASS{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Refacciones y Compras</h1>
  <div class="btn-group">
    <a class="btn btn-primary" href="{% url 'warehouse:sparepart_create' %}">
      <i class="fas fa-plus"></i> Nueva refacción
    </a>&nbsp;&nbsp;
    <a class="btn btn-primary" href="{% url 'warehouse:purchase_create' %}">
      <i class="fas fa-file-invoice-dollar"></i> Registrar compra
    </a>&nbsp;&nbsp;
    <a class="btn btn-primary" href="{% url 'warehouse:payment_create' %}">
      <i class="fas fa-money-bill-wave"></i> Registrar pago
    </a>
  </div>
</div>

<form method="get" class="card mb-3">
  <div class="card-body py-3">
    <div class="form-row align-items-center form-compact">
      <div class="col-md-8 mb-2">
        <div class="input-group input-group-sm">
          {{ search_form.q }}
          <div class="input-group-append">
            <button class="btn btn-outline-primary" type="submit">
              <i class="fas fa-search"></i> Buscar
            </button>
          </div>
        </div>
        <input type="hidden" name="tab" value="{{ tab|default:'spareparts' }}">
      </div>

      <div class="col-md-4 mb-2 text-right d-none d-md-block text-muted small">
        Mostrando {{ spareparts_count|default:spareparts|length }} refacción{{ spareparts_count|default:spareparts|length|pluralize:"es" }}
        · {{ purchases_count|default:purchases|length }} compra{{ purchases_count|default:purchases|length|pluralize:"s" }}
        · {{ payments_count|default:payments|length }} pago{{ payments_count|default:payments|length|pluralize:"s" }}
      </div>
    </div>
  </div>
</form>

<ul class="nav nav-tabs mb-3" id="warehouseTabs" role="tablist">
  <li class="nav-item">
    <a class="nav-link {% if tab == 'spareparts' %}active{% endif %}"
       id="tab-spareparts" data-toggle="tab" href="#pane-spareparts" role="tab">
      <i class="fas fa-cogs"></i> Refacciones
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if tab == 'purchases' %}active{% endif %}"
       id="tab-purchases" data-toggle="tab" href="#pane-purchases" role="tab">
      <i class="fas fa-file-invoice-dollar"></i> Compras
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if tab == 'payments' %}active{% endif %}"
       id="tab-payments" data-toggle="tab" href="#pane-payments" role="tab">
      <i class="fas fa-money-bill-wave"></i> Pagos
    </a>
  </li>
</ul>

<div class="d-flex justify-content-between align-items-center mb-2 small text-muted">
  <div>
    {% if tab == "spareparts" %}
      {% if sp_is_paginated %}
        Mostrando {{ sp_page_obj.start_index }}–{{ sp_page_obj.end_index }} de {{ sp_paginator.count }}
        · Página {{ sp_page_obj.number }} de {{ sp_paginator.num_pages }}
      {% else %}
        {{ spareparts|length }} refacción{{ spareparts|length|pluralize:"es" }}
      {% endif %}
    {% elif tab == "purchases" %}
      {% if p_is_paginated %}
        Mostrando {{ p_page_obj.start_index }}–{{ p_page_obj.end_index }} de {{ p_paginator.count }}
        · Página {{ p_page_obj.number }} de {{ p_paginator.num_pages }}
      {% else %}
        {{ purchases|length }} compra{{ purchases|length|pluralize:"s" }}
      {% endif %}
    {% else %}
      {% if pay_is_paginated %}
        Mostrando {{ pay_page_obj.start_index }}–{{ pay_page_obj.end_index }} de {{ pay_paginator.count }}
        · Página {{ pay_page_obj.number }} de {{ pay_paginator.num_pages }}
      {% else %}
        {{ payments|length }} pago{{ payments|length|pluralize:"s" }}
      {% endif %}
    {% endif %}
  </div>
</div>

<div class="tab-content" id="warehouseTabsContent">

  <!-- ===== REFACCIONES ===== -->
  <div class="tab-pane fade {% if tab == 'spareparts' %}show active{% endif %}" id="pane-spareparts" role="tabpanel">
    <div class="card">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="thead-light">
            <tr>
              <th style="width: 28%;">Refacción</th>
              <th style="width: 14%;">Código</th>
              <th style="width: 18%;">Stock</th>
              <th style="width: 14%;">Unidad</th>
              <th style="width: 10%;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for part in spareparts %}
              <tr>
                <td>
                  <a href="{% url 'warehouse:sparepart_detail' part.pk %}">{{ part.name }}</a>
                  {% if part.description %}
                    <br><small class="text-muted">{{ part.description|truncatechars:80 }}</small>
                  {% endif %}
                </td>
                <td><span class="font-monospace">{{ part.code }}</span></td>
                <td>
                  {% with stock=part.stock_actual %}
                    {% if stock <= part.min_stock %}
                      <span class="badge badge-danger">{{ stock }} {{ part.unit }}</span>
                    {% else %}
                      <span class="badge badge-success">{{ stock }} {{ part.unit }}</span>
                    {% endif %}
                  {% endwith %}
                </td>
                <td>{{ part.unit|default:"pieza" }}</td>
                <td class="text-right">
                  <a href="{% url 'warehouse:sparepart_update' part.pk %}"
                     class="btn btn-sm btn-outline-secondary" title="Editar">
                    <i class="fas fa-edit"></i>
                  </a>
                  <a href="{% url 'warehouse:sparepart_delete' part.pk %}"
                     class="btn btn-sm btn-outline-danger" title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted py-4">
                  No hay refacciones registradas.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if sp_is_paginated %}
      <div class="card-footer py-2">
        <ul class="pagination pagination-sm mb-0">
          {% if sp_page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link"
                 href="?tab=spareparts&spage={{ sp_page_obj.previous_page_number }}&q={{ request.GET.q|urlencode }}">‹</a>
            </li>
          {% endif %}
          {% for i in sp_paginator.page_range %}
            {% if i == sp_page_obj.number %}
              <li class="page-item active"><span class="page-link">{{ i }}</span></li>
            {% elif i >= sp_page_obj.number|add:'-2' and i <= sp_page_obj.number|add:'2' %}
              <li class="page-item">
                <a class="page-link"
                   href="?tab=spareparts&spage={{ i }}&q={{ request.GET.q|urlencode }}">{{ i }}</a>
              </li>
            {% endif %}
          {% endfor %}
          {% if sp_page_obj.has_next %}
            <li class="page-item">
              <a class="page-link"
                 href="?tab=spareparts&spage={{ sp_page_obj.next_page_number }}&q={{ request.GET.q|urlencode }}">›</a>
            </li>
          {% endif %}
        </ul>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- ===== COMPRAS ===== -->
  <div class="tab-pane fade {% if tab == 'purchases' %}show active{% endif %}" id="pane-purchases" role="tabpanel">
    <div class="card">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="thead-light">
            <tr>
              <th style="width: 12%;">Fecha</th>
              <th style="width: 22%;">Proveedor</th>
              <th style="width: 13%;">Factura / Folio</th>
              <th style="width: 10%;">Total</th>
              <th style="width: 10%;">Pagado</th>
              <th style="width: 10%;">Saldo</th>
              <th style="width: 13%;">Estatus</th>
              <th style="width: 10%;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for p in purchases %}
              <tr>
                <td>
                  {% if p.date %}
                    {{ p.date|date:"d/m/Y" }}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>

                <td>
                  {{ p.supplier.nombre|default:"—" }}
                  {% if p.notes %}
                    <br><small class="text-muted">{{ p.notes|truncatechars:60 }}</small>
                  {% endif %}
                </td>

                <td>{{ p.invoice_number|default:"—" }}</td>

                <td>
                  {% if p.total %}
                    ${{ p.total|money_mx }}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>

                <td>
                  {% if p.amount_paid and p.amount_paid > 0 %}
                    ${{ p.amount_paid|money_mx }}
                  {% else %}
                    <span class="text-muted">$0.00</span>
                  {% endif %}
                </td>

                <td>
                  {% if p.balance is not None and p.balance <= 0 %}
                    <span class="badge badge-info">
                      <i class="fas fa-check-circle"></i> Pagada
                    </span>
                  {% else %}
                    <span class="badge badge-light">
                      {% if p.balance %}${{ p.balance|money_mx }}{% else %}$0.00{% endif %}
                    </span>
                  {% endif %}
                </td>

                <td>
                  {% with s=p.status %}
                    {% if s == "APPROVED" %}
                      <span class="badge badge-success">Aprobada</span>
                    {% elif s == "SUBMITTED" %}
                      <span class="badge badge-warning">Pendiente</span>
                    {% elif s == "REJECTED" %}
                      <span class="badge badge-danger">Rechazada</span>
                    {% elif s == "DRAFT" %}
                      <span class="badge badge-secondary">Borrador</span>
                    {% elif s == "CANCELLED" %}
                      <span class="badge badge-dark">Cancelada</span>
                    {% elif s == "CLOSED" %}
                      <span class="badge badge-primary">Cerrada</span>
                    {% else %}
                      <span class="badge badge-light">{{ s }}</span>
                    {% endif %}
                  {% endwith %}
                </td>

                <td class="text-right">
                  <a href="{% url 'warehouse:purchase_detail' p.pk %}"
                     class="btn btn-sm btn-outline-secondary" title="Ver detalle">
                    <i class="fas fa-eye"></i>
                  </a>

                  {% if p.status == "SUBMITTED" %}
                    <a href="{% url 'warehouse:purchase_edit' p.pk %}"
                       class="btn btn-sm btn-outline-warning" title="Aprobar / Rechazar">
                      <i class="fas fa-check"></i>
                    </a>
                  {% endif %}

                  {% if p.status == "APPROVED" and p.balance and p.balance > 0 %}
                    <a href="{% url 'warehouse:payment_create' %}?supplier={{ p.supplier_id }}"
                       class="btn btn-sm btn-outline-success" title="Registrar pago">
                      <i class="fas fa-money-bill-wave"></i>
                    </a>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="8" class="text-center text-muted py-4">
                  No hay compras registradas.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if p_is_paginated %}
      <div class="card-footer py-2">
        <ul class="pagination pagination-sm mb-0">
          {% if p_page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link"
                 href="?tab=purchases&ppage={{ p_page_obj.previous_page_number }}&q={{ request.GET.q|urlencode }}">‹</a>
            </li>
          {% endif %}
          {% for i in p_paginator.page_range %}
            {% if i == p_page_obj.number %}
              <li class="page-item active"><span class="page-link">{{ i }}</span></li>
            {% elif i >= p_page_obj.number|add:'-2' and i <= p_page_obj.number|add:'2' %}
              <li class="page-item">
                <a class="page-link"
                   href="?tab=purchases&ppage={{ i }}&q={{ request.GET.q|urlencode }}">{{ i }}</a>
              </li>
            {% endif %}
          {% endfor %}
          {% if p_page_obj.has_next %}
            <li class="page-item">
              <a class="page-link"
                 href="?tab=purchases&ppage={{ p_page_obj.next_page_number }}&q={{ request.GET.q|urlencode }}">›</a>
            </li>
          {% endif %}
        </ul>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- ===== PAGOS ===== -->
  <div class="tab-pane fade {% if tab == 'payments' %}show active{% endif %}" id="pane-payments" role="tabpanel">
    <div class="card">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="thead-light">
            <tr>
              <th style="width: 12%;">Fecha</th>
              <th style="width: 28%;">Proveedor</th>
              <th style="width: 14%;">Método</th>
              <th style="width: 26%;">Referencia</th>
              <th style="width: 10%;">Monto</th>
              <th style="width: 10%;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for pay in payments %}
              <tr>
                <td>
                  {% if pay.date %}
                    {{ pay.date|date:"d/m/Y" }}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>

                <td>{{ pay.supplier.nombre|default:"—" }}</td>

                <td>
                  {% if pay.method %}
                    {{ pay.get_method_display|default:pay.method }}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>

                <td>
                  {% if pay.reference %}
                    <span class="font-monospace">{{ pay.reference }}</span>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                  {% if pay.notes %}
                    <br><small class="text-muted">{{ pay.notes|truncatechars:60 }}</small>
                  {% endif %}
                </td>

                <td>
                  {% if pay.amount %}
                    ${{ pay.amount|money_mx }}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>

                <td class="text-right">
                  <a href="{% url 'warehouse:payment_detail' pay.pk %}"
                     class="btn btn-sm btn-outline-secondary" title="Ver detalle">
                    <i class="fas fa-eye"></i>
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted py-4">
                  No hay pagos registrados.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if pay_is_paginated %}
      <div class="card-footer py-2">
        <ul class="pagination pagination-sm mb-0">
          {% if pay_page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link"
                 href="?tab=payments&paypage={{ pay_page_obj.previous_page_number }}&q={{ request.GET.q|urlencode }}">‹</a>
            </li>
          {% endif %}
          {% for i in pay_paginator.page_range %}
            {% if i == pay_page_obj.number %}
              <li class="page-item active"><span class="page-link">{{ i }}</span></li>
            {% elif i >= pay_page_obj.number|add:'-2' and i <= pay_page_obj.number|add:'2' %}
              <li class="page-item">
                <a class="page-link"
                   href="?tab=payments&paypage={{ i }}&q={{ request.GET.q|urlencode }}">{{ i }}</a>
              </li>
            {% endif %}
          {% endfor %}
          {% if pay_page_obj.has_next %}
            <li class="page-item">
              <a class="page-link"
                 href="?tab=payments&paypage={{ pay_page_obj.next_page_number }}&q={{ request.GET.q|urlencode }}">›</a>
            </li>
          {% endif %}
        </ul>
      </div>
      {% endif %}
    </div>
  </div>

</div>

<script>
  document.getElementById("tab-spareparts")?.addEventListener("click", () => {
    const u = new URL(window.location);
    u.searchParams.set("tab", "spareparts");
    u.searchParams.delete("ppage");
    u.searchParams.delete("paypage");
    window.history.replaceState({}, "", u);
  });

  document.getElementById("tab-purchases")?.addEventListener("click", () => {
    const u = new URL(window.location);
    u.searchParams.set("tab", "purchases");
    u.searchParams.delete("spage");
    u.searchParams.delete("paypage");
    window.history.replaceState({}, "", u);
  });

  document.getElementById("tab-payments")?.addEventListener("click", () => {
    const u = new URL(window.location);
    u.searchParams.set("tab", "payments");
    u.searchParams.delete("spage");
    u.searchParams.delete("ppage");
    window.history.replaceState({}, "", u);
  });
</script>

{% endblock %}
```
