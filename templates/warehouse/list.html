{% extends "base.html" %}
{% load currency_extras %}

{% block title %}Refacciones y Compras · BASS{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Refacciones y Compras</h1>
  <div class="btn-group">
    <a class="btn btn-primary" href="{% url 'warehouse:sparepart_create' %}">
      <i class="fas fa-plus"></i> Nueva refacción
    </a>&nbsp;&nbsp;
    <a class="btn btn-primary" href="{% url 'warehouse:purchase_create' %}">
      <i class="fas fa-file-invoice-dollar"></i> Registrar compra
    </a>
  </div>
</div>

<form method="get" class="card mb-3">
  <div class="card-body py-3">
    <div class="form-row align-items-center form-compact">
      <div class="col-md-8 mb-2">
        <div class="input-group input-group-sm">
          {{ search_form.q }}
          <div class="input-group-append">
            <button class="btn btn-outline-primary" type="submit">
              <i class="fas fa-search"></i> Buscar
            </button>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-2 text-right d-none d-md-block text-muted small">
        Mostrando {{ spareparts|length }} refacción{{ spareparts|length|pluralize:"es" }}
        · {{ purchases|length }} compra{{ purchases|length|pluralize:"s" }}
      </div>
    </div>
  </div>
</form>

<ul class="nav nav-tabs mb-3" id="warehouseTabs" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="tab-spareparts" data-toggle="tab" href="#pane-spareparts" role="tab">
      <i class="fas fa-cogs"></i> Refacciones
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="tab-purchases" data-toggle="tab" href="#pane-purchases" role="tab">
      <i class="fas fa-file-invoice-dollar"></i> Compras
    </a>
  </li>
</ul>

<div class="tab-content" id="warehouseTabsContent">
  <!-- ===== REFACCIONES ===== -->
  <div class="tab-pane fade show active" id="pane-spareparts" role="tabpanel">
    <div class="card">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="thead-light">
            <tr>
              <th style="width: 28%;">Refacción</th>
              <th style="width: 14%;">Código</th>
              <th style="width: 18%;">Stock</th>
              <th style="width: 14%;">Unidad</th>
              <th style="width: 10%;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for part in spareparts %}
              <tr>
                <!-- Refacción: nombre + descripción corta -->
                <td>
                  <a href="{% url 'warehouse:sparepart_detail' part.pk %}">
                    {{ part.name }}
                  </a>
                  {% if part.description %}
                    <br>
                    <small class="text-muted">
                      {{ part.description|truncatechars:80 }}
                    </small>
                  {% endif %}
                </td>

                <!-- Código -->
                <td>
                  <span class="font-monospace">{{ part.code }}</span>
                </td>

                <!-- Stock actual (con alerta si está bajo el mínimo) -->
                <td>
                  {% with stock=part.stock_actual %}
                    {% if stock <= part.min_stock %}
                      <span class="badge badge-danger">
                        {{ stock }} {{ part.unit }}
                      </span>
                      <br>
                      <small class="text-muted">
                        Mínimo: {{ part.min_stock }} {{ part.unit }}
                      </small>
                    {% else %}
                      <span class="badge badge-success">
                        {{ stock }} {{ part.unit }}
                      </span>
                      {% if part.min_stock %}
                        <br>
                        <small class="text-muted">
                          Mínimo: {{ part.min_stock }} {{ part.unit }}
                        </small>
                      {% endif %}
                    {% endif %}
                  {% endwith %}
                </td>

                <!-- Unidad de medida -->
                <td>
                  {{ part.unit|default:"pieza" }}
                </td>

                <!-- Acciones -->
                <td class="text-right">
                  <a href="{% url 'warehouse:sparepart_update' part.pk %}"
                     class="btn btn-sm btn-outline-secondary"
                     title="Editar">
                    <i class="fas fa-edit"></i>
                  </a>
                  <a href="{% url 'warehouse:sparepart_delete' part.pk %}"
                     class="btn btn-sm btn-outline-danger"
                     title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted py-4">
                  No hay refacciones registradas.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== COMPRAS ===== -->
  <div class="tab-pane fade" id="pane-purchases" role="tabpanel">
    <div class="card">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="thead-light">
            <tr>
              <th style="width: 15%;">Fecha</th>
              <th style="width: 30%;">Proveedor</th>
              <th style="width: 15%;">Factura / Folio</th>
              <th style="width: 15%;">Total</th>
              <th style="width: 15%;">Partidas</th>
              <th style="width: 10%;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for p in purchases %}
              <tr>
                <td>
                  {% if p.date %}
                    {{ p.date|date:"d/m/Y" }}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>

                <td>
                  <a href="{% url 'warehouse:purchase_detail' p.pk %}">
                    {{ p.supplier_name|default:"—" }}
                  </a>
                  {% if p.notes %}
                    <br>
                    <small class="text-muted">{{ p.notes|truncatechars:60 }}</small>
                  {% endif %}
                </td>

                <td>
                  {{ p.invoice_number|default:"—" }}
                </td>

                <td>
                  {% if p.total %}
                    ${{ p.total|money_mx }}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>

                <td>
                  {{ p.items.count }} partida{{ p.items.count|pluralize:"s" }}
                </td>

                <td class="text-right">
                  <a href="{% url 'warehouse:purchase_detail' p.pk %}"
                     class="btn btn-sm btn-outline-secondary"
                     title="Ver detalle">
                    <i class="fas fa-eye"></i>
                  </a>
                  <a href="#"
                     class="btn btn-sm btn-outline-secondary"
                     title="Editar">
                    <i class="fas fa-edit"></i>
                  </a>
                  <a href="#"
                     class="btn btn-sm btn-outline-danger"
                     title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted py-4">
                  No hay compras registradas.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% endblock %}
