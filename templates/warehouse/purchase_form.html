{% extends "base.html" %}
{% load form_extras %}
{% load currency_extras %}

{% block title %}
  {% if is_status_edit %}Actualizar estatus de compra · BASS{% else %}Nueva compra de refacciones · BASS{% endif %}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">
    {% if is_status_edit %}Actualizar estatus de compra{% else %}Nueva compra de refacciones{% endif %}
  </h1>
  <a href="{% url 'warehouse:sparepart_list' %}" class="btn btn-light btn-sm">
    <i class="fas fa-arrow-left"></i> Volver
  </a>
</div>

<form method="post" class="card shadow-sm form-compact">
  {% csrf_token %}
  <div class="card-body">

    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {% for e in form.non_field_errors %}{{ e }}<br>{% endfor %}
      </div>
    {% endif %}

    <!-- CABECERA -->
    <h6 class="text-primary mb-2">
      <i class="fas fa-file-invoice mr-1"></i> Datos de la compra
    </h6>

    {% if is_status_edit %}
      <!-- Solo lectura -->
      <div class="form-row">
        <div class="form-group col-md-6">
          <label>Proveedor</label>
          <input class="form-control" value="{{ object.supplier|default:'—' }}" disabled>
        </div>
        <div class="form-group col-md-3">
          <label>Factura / Folio</label>
          <input class="form-control" value="{{ object.invoice_number|default:'—' }}" disabled>
        </div>
        <div class="form-group col-md-3">
          <label>Fecha</label>
          <input class="form-control" value="{% if object.date %}{{ object.date|date:'Y-m-d' }}{% endif %}" disabled>
        </div>
      </div>

      <div class="form-group">
        <label>Notas</label>
        <textarea class="form-control" rows="2" disabled>{{ object.notes|default:"" }}</textarea>
      </div>

      <hr>

      <!-- Editable: STATUS -->
      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="{{ form.status.id_for_label }}">Estatus</label>
          {{ form.status|add_class:"form-control" }}
          <small class="text-muted">
            Cambiar a <b>Aprobada</b> registrará entradas a inventario si aún no existen.
          </small>
        </div>
        <div class="form-group col-md-6 d-flex align-items-end justify-content-end">
          <span class="text-muted small">
            Total: <b>${{ object.total|money_mx }}</b>
          </span>
        </div>
      </div>

    {% else %}
      <!-- Modo creación: editable -->
      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="{{ form.supplier.id_for_label }}">Proveedor</label>
          {{ form.supplier|add_class:"form-control" }}
        </div>
        <div class="form-group col-md-3">
          <label for="{{ form.invoice_number.id_for_label }}">Factura / Folio</label>
          {{ form.invoice_number|add_class:"form-control" }}
        </div>
        <div class="form-group col-md-3">
          <label for="{{ form.date.id_for_label }}">Fecha</label>
          {{ form.date|add_class:"form-control" }}
        </div>
      </div>

      <div class="form-group">
        <label for="{{ form.notes.id_for_label }}">Notas</label>
        {{ form.notes|add_class:"form-control" }}
      </div>
    {% endif %}

    <hr>

    <!-- PARTIDAS -->
    <h6 class="text-primary mb-2">
      <i class="fas fa-list-ul mr-1"></i> Partidas de refacciones
    </h6>

    {% if is_status_edit %}
      <div class="table-responsive">
        <table class="table table-sm table-bordered mb-0">
          <thead class="thead-light">
            <tr class="small text-center">
              <th style="width: 45%;">Refacción</th>
              <th style="width: 15%;">Cantidad</th>
              <th style="width: 20%;">Precio unitario</th>
              <th>Notas</th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
              <tr class="small">
                <td>{{ item.spare_part.name }}</td>
                <td class="text-center">
                  {{ item.quantity }} {{ item.spare_part.unit|default:"pieza" }}
                </td>
                <td class="text-right">
                  {% if item.unit_price %}${{ item.unit_price|money_mx }}{% else %}<span class="text-muted">—</span>{% endif %}
                </td>
                <td>{{ item.notes|default:"" }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted py-3 small">
                  Esta compra no tiene partidas registradas.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    {% else %}
      {{ item_formset.management_form }}
      <div class="table-responsive">
        <table class="table table-sm table-bordered mb-0">
          <thead class="thead-light">
            <tr class="small text-center">
              <th style="width: 45%;">Refacción</th>
              <th style="width: 15%;">Cantidad</th>
              <th style="width: 20%;">Precio unitario</th>
              <th>Notas</th>
            </tr>
          </thead>
          <tbody>
            {% for f in item_formset.forms %}
              <tr class="small">
                <td>{{ f.spare_part|add_class:"form-control form-control-sm" }}</td>
                <td>{{ f.quantity|add_class:"form-control form-control-sm" }}</td>
                <td>{{ f.unit_price|add_class:"form-control form-control-sm" }}</td>
                <td>{{ f.notes|add_class:"form-control form-control-sm" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if item_formset.non_form_errors %}
        <div class="alert alert-danger mt-2">
          {% for e in item_formset.non_form_errors %}{{ e }}<br>{% endfor %}
        </div>
      {% endif %}
    {% endif %}

  </div>

  <div class="card-footer text-right py-2">
    <button class="btn btn-primary btn-sm" type="submit">
      <i class="fas fa-save"></i>
      {% if is_status_edit %}Guardar{% else %}Guardar compra{% endif %}
    </button>
  </div>
</form>
{% endblock %}
