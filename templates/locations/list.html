{% extends "base.html" %}
{% load currency_extras %}

{% block title %}Rutas y Ubicaciones · BASS{% endblock %}
{% block content %}

{# ===== RUTAS ES EL TAB POR DEFECTO ===== #}
{% with active_tab=request.GET.tab|default:"routes" %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">
    {% if active_tab == "routes" %}Rutas{% else %}Ubicaciones{% endif %}
  </h1>

  {% if active_tab == "routes" %}
    <a class="btn btn-primary" href="{% url 'locations:routes_create' %}">
      <i class="fas fa-plus"></i> Nueva ruta
    </a>
  {% else %}
    <a class="btn btn-primary" href="{% url 'locations:create' %}">
      <i class="fas fa-plus"></i> Nueva ubicación
    </a>
  {% endif %}
</div>

<!-- ===== TABS ===== -->
<ul class="nav nav-tabs mb-3">
  <li class="nav-item">
    <a class="nav-link {% if active_tab == 'routes' %}active{% endif %}"
       href="?tab=routes&q={{ request.GET.q|urlencode }}&status={{ request.GET.status|urlencode }}">
      <i class="fas fa-route"></i> Rutas
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if active_tab == 'locations' %}active{% endif %}"
       href="?tab=locations&q={{ request.GET.q|urlencode }}&status={{ request.GET.status|urlencode }}">
      <i class="fas fa-map-marker-alt"></i> Ubicaciones
    </a>
  </li>
</ul>

<!-- ===== FILTROS ===== -->
<form method="get" class="card mb-3">
  <input type="hidden" name="tab" value="{{ active_tab }}">
  <div class="card-body py-3">
    <div class="form-row align-items-center form-compact">

      <div class="col-md-6 mb-2">
        <div class="input-group input-group-sm">
          {{ search_form.q }}
          <div class="input-group-append">
            <button class="btn btn-outline-primary" type="submit">
              <i class="fas fa-search"></i> Buscar
            </button>
          </div>
        </div>
      </div>

      <div class="col-md-3 mb-2">
        {{ search_form.status }}
      </div>

      <div class="col-md-3 mb-2 d-none d-md-block"></div>
    </div>
  </div>
</form>

{% if active_tab == "routes" %}

<!-- ===== LISTA DE RUTAS ===== -->

<div class="d-flex justify-content-between align-items-center mb-2 small text-muted">
  <div>{{ routes|length }} ruta{{ routes|length|pluralize:"s" }}</div>
</div>

<div class="card">
  <div class="table-responsive">
    <table class="table table-hover mb-0">
      <thead class="thead-light">
        <tr>
          <th>Ruta / Cliente</th>
          <th>Origen</th>
          <th>Destino</th>
          <th>Tarifa cliente</th>
          <th>Pago operador</th>
          <th>Status</th>
          <th style="width:120px;">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for r in routes %}
        <tr>
          <td>
            <a href="{% url 'locations:routes_detail' r.pk %}">
              {{ r.display_name|default:r.nombre }}
            </a>
            <br><small class="text-muted">{{ r.client.nombre }}</small>
          </td>

          <td>
            {{ r.origen.nombre }}
            {% if r.origen.full_address %}
              <br><small class="text-muted">{{ r.origen.full_address }}</small>
            {% endif %}
          </td>

          <td>
            {{ r.destino.nombre }}
            {% if r.destino.full_address %}
              <br><small class="text-muted">{{ r.destino.full_address }}</small>
            {% endif %}
          </td>

          <!-- ===== TARIFA CLIENTE ===== -->
          <td>
            ${{ r.tarifa_cliente|money_mx }}
          </td>

          <!-- ===== PAGO OPERADOR ===== -->
          <td>
            ${{ r.pago_operador|money_mx }}
          </td>

          <td>
            {% if r.deleted %}
              <span class="badge badge-danger">Eliminada</span>
            {% else %}
              <span class="badge badge-success">Activa</span>
            {% endif %}
          </td>

          <td class="text-right">
            <a href="{% url 'locations:routes_detail' r.pk %}"
              class="btn btn-sm btn-outline-secondary" title="Ver detalle">
              <i class="fas fa-eye"></i>
            </a>
            <a href="{% url 'locations:routes_edit' r.pk %}"
               class="btn btn-sm btn-outline-secondary" title="Editar tarifas">
              <i class="fas fa-edit"></i>
            </a>
            <a href="{% url 'locations:routes_delete' r.pk %}"
               class="btn btn-sm btn-outline-danger" title="Eliminar">
              <i class="fas fa-trash"></i>
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center text-muted py-4">
            Sin resultados.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% else %}

<!-- ===== TABLA DE UBICACIONES ===== -->

<div class="d-flex justify-content-between align-items-center mb-2 small text-muted">
  <div>{{ locations|length }} ubicación{{ locations|length|pluralize:"es" }}</div>
</div>

<div class="card">
  <div class="table-responsive">
    <table class="table table-hover mb-0">
      <thead class="thead-light">
        <tr>
          <th>Ubicación / Cliente</th>
          <th>Dirección</th>
          <th>Contacto</th>
          <th>Status</th>
          <th style="width:120px;">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for l in locations %}
        <tr>
          <td>
            <a href="{% url 'locations:detail' l.pk %}">{{ l.nombre }}</a>
            <br><small class="text-muted">{{ l.client.nombre }}</small>
          </td>

          <td>
            {{ l.full_address|default:"—" }}
          </td>

          <td>
            {{ l.contacto|default:"—" }}
          </td>

          <td>
            {% if l.deleted %}
              <span class="badge badge-danger">Eliminada</span>
            {% else %}
              <span class="badge badge-success">Activa</span>
            {% endif %}
          </td>

          <td class="text-right">
            <a href="{% url 'locations:detail' l.pk %}"
              class="btn btn-sm btn-outline-secondary" title="Ver detalle">
              <i class="fas fa-eye"></i>
            </a>
            <a href="{% url 'locations:edit' l.pk %}" class="btn btn-sm btn-outline-secondary">
              <i class="fas fa-edit"></i>
            </a>
            <a href="{% url 'locations:delete' l.pk %}" class="btn btn-sm btn-outline-danger">
              <i class="fas fa-trash"></i>
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="text-center text-muted py-4">
            Sin resultados.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endif %}
{% endwith %}
{% endblock %}