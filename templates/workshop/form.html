{% extends "base.html" %}
{% load form_extras %}
{% block title %}{% if object %}Editar orden de taller{% else %}Nueva orden de taller{% endif %} · BASS{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">
    {% if object %}Editar orden de taller{% else %}Nueva orden de taller{% endif %}
  </h1>
  <a href="{% url 'workshop:list' %}" class="btn btn-light btn-sm">
    <i class="fas fa-arrow-left"></i> Volver
  </a>
</div>

<form method="post" class="card shadow-sm form-compact">
  {% csrf_token %}
  <div class="card-body">

    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {% for e in form.non_field_errors %}{{ e }}<br>{% endfor %}
      </div>
    {% endif %}

    <!-- =======================
         DATOS DE LA ORDEN
    ======================== -->
    <h6 class="text-primary mb-2">
      <i class="fas fa-tools mr-1"></i> Datos de la orden
    </h6>

    <div class="form-row">

      {% if object %}
        <div class="form-group col-md-4">
          <label>Unidad</label>
          <input type="text"
                 class="form-control form-control-sm"
                 value="{{ object.unidad_display }}"
                 readonly>
        </div>
      {% else %}
        <div class="form-group col-md-4" id="field-truck">
          <label for="{{ form.truck.id_for_label }}">Camión</label>
          {{ form.truck|add_class:"form-control" }}
        </div>
        <div class="form-group col-md-4" id="field-reefer-box">
          <label for="{{ form.reefer_box.id_for_label }}">Caja</label>
          {{ form.reefer_box|add_class:"form-control" }}
        </div>
      {% endif %}

      <div class="form-group col-md-4">
        <label>Fecha de entrada</label>
        <input type="text"
               class="form-control form-control-sm"
               value="{% if object %}{{ object.fecha_entrada|date:'d/m/Y H:i' }}{% else %}Se asignará automáticamente{% endif %}"
               readonly>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group col-md-4">
        <label for="{{ form.fecha_salida_estimada.id_for_label }}">Fecha salida estimada</label>
        {{ form.fecha_salida_estimada|add_class:"form-control" }}
      </div>

      {% if object %}
        <div class="form-group col-md-4">
          <label for="{{ form.estado.id_for_label }}">Estado</label>
          {{ form.estado|add_class:"form-control" }}
        </div>
      {% endif %}
    </div>

    <!-- =========================
         DESCRIPCIÓN
    ========================== -->
    <hr>
    <h6 class="text-primary mb-2">
      <i class="fas fa-exclamation-triangle mr-1"></i> Descripción de la falla
    </h6>

    <div class="form-row">
      <div class="form-group col-md-12">
        <label>Motivo por el que entra a taller</label>
        {% if object %}
          <textarea class="form-control form-control-sm" rows="3" readonly>{{ object.descripcion }}</textarea>
        {% else %}
          {{ form.descripcion|add_class:"form-control" }}
        {% endif %}
      </div>
    </div>

    {% if object %}
      <!-- =========================
           COSTOS
      ========================== -->
      <hr>
      <h6 class="text-primary mb-2">
        <i class="fas fa-dollar-sign mr-1"></i> Costos
      </h6>

      <div class="form-row">
        <div class="form-group col-md-4">
          <label for="{{ form.costo_mano_obra.id_for_label }}">Mano de obra</label>
          {{ form.costo_mano_obra|add_class:"form-control" }}
        </div>
        <div class="form-group col-md-4">
          <label for="{{ form.otros_costos.id_for_label }}">Otros costos</label>
          {{ form.otros_costos|add_class:"form-control" }}
        </div>
      </div>

            <!-- =========================
           REFACCIONES USADAS
      ========================== -->
      <hr>
      <h6 class="text-primary mb-2">
        <i class="fas fa-cog mr-1"></i> Refacciones usadas en esta orden
      </h6>

      {{ formset.management_form }}

      <table class="table table-sm table-bordered">
        <thead class="thead-light">
          <tr class="small">
            <th style="width: 70%;">Refacción</th>
            <th style="width: 20%;">Cantidad</th>
            <th style="width: 10%;">Eliminar</th>
          </tr>
        </thead>
        <tbody>
          {% for f in formset %}
            <tr>
              <td>{{ f.spare_part }}</td>
              <td>{{ f.quantity }}</td>
              <td class="text-center">
                <!-- Checkbox DELETE oculto -->
                <span class="d-none">
                  {{ f.DELETE }}
                </span>
                <!-- Botón que marca el DELETE -->
                <button type="button"
                        class="btn btn-sm btn-outline-danger btn-delete-usage-row"
                        title="Eliminar refacción de esta orden">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <p class="text-muted small mb-0">
        Las cantidades se descuentan automáticamente del inventario al guardar.
      </p>

      <!-- =========================
           NOTAS
      ========================== -->
      <hr>
      <h6 class="text-primary mb-2">
        <i class="fas fa-sticky-note mr-1"></i> Notas internas
      </h6>

      <div class="form-group">
        <label for="{{ form.notas_internas.id_for_label }}">Notas</label>
        {{ form.notas_internas|add_class:"form-control" }}
      </div>

    {% endif %}

  </div>

  <div class="card-footer text-right py-2">
    <button class="btn btn-primary btn-sm" type="submit">
      {% if object %}
        <i class="fas fa-save"></i> Guardar cambios
      {% else %}
        <i class="fas fa-save"></i> Crear orden
      {% endif %}
    </button>
  </div>
</form>

<!-- ======================
     Script para bloqueo TRUCK vs BOX
====================== -->
<script>
(function() {
  const truckSelect = document.getElementById('id_truck');
  const boxSelect   = document.getElementById('id_reefer_box');

  function updateUnidadLock() {
    if (!truckSelect || !boxSelect) return;

    const truckVal = truckSelect.value;
    const boxVal   = boxSelect.value;

    boxSelect.disabled  = !!truckVal;
    truckSelect.disabled = !!boxVal;

    if (truckVal) boxSelect.value = "";
    if (boxVal) truckSelect.value = "";
  }

  if (truckSelect) truckSelect.addEventListener('change', updateUnidadLock);
  if (boxSelect)   boxSelect.addEventListener('change', updateUnidadLock);

  updateUnidadLock();
})();
</script>
<script>
(function() {
  // Botón "Eliminar" en filas de refacciones usadas
  function hookDeleteButtons() {
    document.querySelectorAll('.btn-delete-usage-row').forEach(function(btn) {
      if (btn._wired) return;
      btn._wired = true;

      btn.addEventListener('click', function() {
        const row = this.closest('tr');
        if (!row) return;

        const checkbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
        if (checkbox) {
          checkbox.checked = true;
          // Opcional: ocultar visualmente la fila
          row.classList.add('table-danger');
          row.style.display = 'none';
        }
      });
    });
  }

  // Ejecutar al cargar
  hookDeleteButtons();
})();
</script>


{% endblock %}
