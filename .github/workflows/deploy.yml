name: deploy-bass

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      - name: Test TCP connectivity
        run: |
          echo "Testing port 22..."
          nc -zv ${{ secrets.SSH_HOST }} 22

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e

            echo "ğŸ“ Go to app directory"
            cd /home/ubuntu/bass

            echo "ğŸ”„ Pull latest code"
            git pull origin main

            echo "ğŸ³ Build containers locally"
            docker compose build
            
            echo "âŒ¨ï¸Run migrations"
            docker compose run --rm web python manage.py migrate

            echo "ğŸš€ Start containers"
            docker compose up -d

            echo "ğŸ§¹ Cleanup"
            docker image prune -f

